<p-card>
  <!-- Header -->
  <ng-template pTemplate="header">
    <div class="border-l-4 border-[#fb0021] pl-4 py-4">
      <h3 class="text-lg font-semibold text-surface-900 dark:text-surface-50">Filtros de Búsqueda SAAO</h3>
      <p class="text-sm text-surface-600 dark:text-surface-400 mt-1">
        Configura los filtros para cargar el reporte de análisis de órdenes
      </p>
    </div>
  </ng-template>

  <form [formGroup]="filtersForm" class="space-y-6">

    <!-- FILTROS OBLIGATORIOS -->
    <div class="bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-3">
        <i class="pi pi-star text-blue-600 dark:text-blue-400"></i>
        <h4 class="text-sm font-semibold text-blue-900 dark:text-blue-100">Filtros Obligatorios</h4>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Ciudad (OBLIGATORIO) -->
        <div class="flex flex-col">
          <label class="text-sm font-medium text-surface-700 dark:text-surface-300 mb-2 flex items-center gap-1">
            <i class="pi pi-building text-[#fb0021]"></i>
            <span>Ciudad</span>
            <span class="text-red-500 dark:text-red-400">*</span>
          </label>
          <p-select
            formControlName="cityId"
            [options]="cities()"
            optionLabel="cityName"
            optionValue="cityId"
            placeholder="Seleccionar ciudad..."
            [showClear]="true"
            [loading]="loadingCities()"
            styleClass="w-full"
          ></p-select>
          @if (filtersForm.get('cityId')?.invalid && filtersForm.get('cityId')?.touched) {
            <span class="text-xs text-red-500 dark:text-red-400 mt-1">La ciudad es obligatoria</span>
          }
        </div>

        <!-- Rango de Fechas (OBLIGATORIO) -->
        <div class="flex flex-col">
          <label class="text-sm font-medium text-surface-700 dark:text-surface-300 mb-2 flex items-center gap-1">
            <i class="pi pi-calendar text-[#fb0021]"></i>
            <span>Rango de Fechas</span>
            <span class="text-red-500 dark:text-red-400">*</span>
          </label>
          <p-datepicker
            formControlName="dateRange"
            [showIcon]="true"
            placeholder="Seleccionar rango..."
            dateFormat="dd/mm/yy"
            selectionMode="range"
            [readonlyInput]="true"
            styleClass="w-full"
          ></p-datepicker>
          @if (filtersForm.get('dateRange')?.invalid && filtersForm.get('dateRange')?.touched) {
            <span class="text-xs text-red-500 dark:text-red-400 mt-1">El rango de fechas es obligatorio</span>
          }
          <p class="text-xs text-surface-500 dark:text-surface-400 mt-1">
            Selecciona desde - hasta
          </p>
        </div>

      </div>
    </div>

    <!-- BÚSQUEDA RÁPIDA DE DRIVER -->
    <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-950/30 dark:to-blue-950/30 border border-purple-200 dark:border-purple-800 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-3">
        <i class="pi pi-search text-purple-600 dark:text-purple-400"></i>
        <h4 class="text-sm font-semibold text-purple-900 dark:text-purple-100">Búsqueda Rápida por Driver ID</h4>
      </div>

      <div class="flex gap-3 items-end">
        <!-- Search Input -->
        <div class="flex-1 max-w-xs">
          <label class="text-xs font-medium text-surface-700 dark:text-surface-300 mb-1 block">ID del Driver</label>
          <input
            pInputText
            type="number"
            [value]="searchDriverId()"
            (input)="searchDriverId.set($any($event.target).value)"
            (keyup.enter)="searchDriver()"
            placeholder="Ej: 1428"
            class="w-full">
        </div>

        <!-- Search Button -->
        <p-button
          label="{{ searchingDriver() ? 'Buscando...' : 'Buscar' }}"
          icon="pi pi-search"
          (onClick)="searchDriver()"
          [disabled]="searchingDriver() || !searchDriverId()"
          [loading]="searchingDriver()"
          severity="help"
        ></p-button>
      </div>

      <!-- Driver Found Card -->
      @if (searchedDriver()) {
        <div class="mt-3 bg-surface-0 dark:bg-surface-900 border border-purple-200 dark:border-purple-800 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <h5 class="text-sm font-semibold text-surface-900 dark:text-surface-50">{{ searchedDriver()!.fullname }}</h5>
                <p-tag [value]="searchedDriver()!.driverCode" severity="contrast"></p-tag>
              </div>
              <div class="flex items-center gap-1.5 flex-wrap">
                <p-tag
                  [value]="searchedDriver()!.status ? 'Activo' : 'Inactivo'"
                  [severity]="searchedDriver()!.status ? 'success' : 'secondary'"
                ></p-tag>
                <p-tag
                  [value]="searchedDriver()!.isAvailableForAssignment ? 'Disponible' : 'Ocupado'"
                  [severity]="searchedDriver()!.isAvailableForAssignment ? 'info' : 'warn'"
                ></p-tag>
                @if (searchedDriver()!.hasActivePenalty) {
                  <p-tag value="⚠ Penalizado" severity="danger"></p-tag>
                }
              </div>
            </div>
            <p-button
              icon="pi pi-times"
              (onClick)="clearDriverSearch()"
              [text]="true"
              [rounded]="true"
              severity="secondary"
              size="small"
            ></p-button>
          </div>
        </div>
      }

      <!-- Driver Not Found -->
      @if (driverNotFound()) {
        <div class="mt-3 bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-lg p-3 flex items-center gap-2">
          <i class="pi pi-exclamation-circle text-red-500 dark:text-red-400"></i>
          <span class="text-sm text-red-700 dark:text-red-400">Driver no encontrado</span>
        </div>
      }
    </div>

    <!-- FILTROS OPCIONALES -->
    <div class="bg-surface-50 dark:bg-surface-900 border border-surface-200 dark:border-surface-700 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-3">
        <i class="pi pi-sliders-h text-surface-600 dark:text-surface-400"></i>
        <h4 class="text-sm font-semibold text-surface-900 dark:text-surface-50">Filtros Opcionales</h4>
        <span class="text-xs text-surface-500 dark:text-surface-400">(Opcional - Refina la búsqueda)</span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

        <!-- Driver Filter -->
        <div class="filter-group">
          <label class="text-sm font-medium text-surface-700 dark:text-surface-300 mb-2 flex items-center gap-1">
            <i class="pi pi-car text-[#fb0021]"></i>
            <span>Driver</span>
          </label>
          <p-select
            formControlName="driverId"
            [options]="drivers()"
            optionLabel="fullNameDriver"
            optionValue="idDriver"
            placeholder="Seleccionar driver..."
            [showClear]="true"
            [loading]="loadingDrivers()"
            [disabled]="!filtersForm.get('cityId')?.value"
            styleClass="w-full"
            [filter]="true"
            filterPlaceholder="Buscar driver..."
          >
            <ng-template pTemplate="item" let-driver>
              <div class="flex items-center gap-2">
                <span>{{ driver.codeDriver }} - {{ driver.fullNameDriver }}</span>
              </div>
            </ng-template>
          </p-select>
          <p class="text-xs text-surface-500 dark:text-surface-400 mt-1">
            @if (!filtersForm.get('cityId')?.value) {
              Selecciona una ciudad primero
            } @else {
              Filtrar órdenes de un driver específico
            }
          </p>
        </div>

        <!-- Store/Restaurant Filter -->
        <div class="filter-group">
          <label class="text-sm font-medium text-surface-700 dark:text-surface-300 mb-2 flex items-center gap-1">
            <i class="pi pi-shop text-[#fb0021]"></i>
            <span>Restaurante</span>
          </label>
          <p-select
            formControlName="storeId"
            [options]="stores()"
            optionLabel="restShortName"
            optionValue="restId"
            placeholder="Seleccionar restaurante..."
            [showClear]="true"
            [loading]="loadingStores()"
            [disabled]="!filtersForm.get('cityId')?.value"
            styleClass="w-full"
            [filter]="true"
            filterPlaceholder="Buscar restaurante..."
          >
            <ng-template pTemplate="item" let-store>
              <div class="flex items-center gap-2">
                @if (store.restBrandLogo) {
                  <img [src]="store.restBrandLogo" [alt]="store.restShortName" class="w-6 h-6 object-contain">
                }
                <span>{{ store.restShortName }} - {{ store.restName }}</span>
              </div>
            </ng-template>
          </p-select>

          <!-- Contador de Drivers Activos -->
          @if (activeDriversCount() !== null && filtersForm.get('storeId')?.value) {
            <div class="mt-2 inline-flex items-center gap-2 px-3 py-1.5 bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-md">
              <i class="pi pi-users text-green-600 dark:text-green-400"></i>
              <span class="text-sm font-medium text-green-900 dark:text-green-100">
                {{ activeDriversCount() }} driver{{ activeDriversCount() !== 1 ? 's' : '' }} activo{{ activeDriversCount() !== 1 ? 's' : '' }}
              </span>
            </div>
          }

          @if (loadingActiveDrivers()) {
            <div class="mt-2 inline-flex items-center gap-2 px-3 py-1.5 bg-surface-50 dark:bg-surface-900 border border-surface-200 dark:border-surface-700 rounded-md">
              <i class="pi pi-spin pi-spinner text-surface-600 dark:text-surface-400"></i>
              <span class="text-xs text-surface-600 dark:text-surface-400">Cargando drivers...</span>
            </div>
          }

          <p class="text-xs text-surface-500 dark:text-surface-400 mt-1">
            @if (!filtersForm.get('cityId')?.value) {
              Selecciona una ciudad primero
            } @else {
              Filtrar órdenes de un restaurante específico
            }
          </p>
        </div>

        <!-- Order IDs Filter (Manual Input) -->
        <div class="filter-group">
          <label class="text-sm font-medium text-surface-700 dark:text-surface-300 mb-2 flex items-center gap-1">
            <i class="pi pi-receipt text-[#fb0021]"></i>
            <span>IDs de Órdenes</span>
          </label>
          <p-iconfield iconPosition="left">
            <p-inputicon styleClass="pi pi-search"></p-inputicon>
            <input
              pInputText
              type="text"
              formControlName="orderIds"
              placeholder="Ej: 4388169, 4389774, 4389831"
              class="w-full"
            />
          </p-iconfield>
          <p class="text-xs text-surface-500 dark:text-surface-400 mt-1">
            Ingresa los IDs de órdenes separados por comas
          </p>
        </div>

      </div>

      <!-- Tip Card -->
      <div class="bg-surface-0 dark:bg-surface-950 border border-surface-200 dark:border-surface-700 rounded-lg p-3 mt-4">
        <div class="flex items-start gap-2">
          <i class="pi pi-lightbulb text-surface-600 dark:text-surface-400 mt-0.5"></i>
          <div class="flex-1">
            <p class="text-xs font-medium text-surface-900 dark:text-surface-50">Tip de Uso</p>
            <ul class="text-xs text-surface-600 dark:text-surface-400 mt-1 space-y-0.5">
              <li>• Primero selecciona ciudad y fecha para habilitar los demás filtros</li>
              <li>• Usa los filtros opcionales para análisis más específicos</li>
              <li>• Los filtros se aplican en conjunto para refinar la búsqueda</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-end gap-3 pt-4 border-t border-surface-200 dark:border-surface-700">
      <p-button
        label="Limpiar Filtros"
        icon="pi pi-times"
        (onClick)="clearFilters()"
        [outlined]="true"
        severity="secondary"
      ></p-button>

      <p-button
        label="Buscar Reporte"
        icon="pi pi-search"
        (onClick)="applyFilters()"
        [disabled]="filtersForm.invalid"
        severity="danger"
      ></p-button>
    </div>

    <!-- Info de campos obligatorios -->
    <div class="flex items-center gap-2 text-xs text-surface-500 dark:text-surface-400 pt-2">
      <i class="pi pi-info-circle"></i>
      <span>Los campos marcados con <span class="text-red-500 dark:text-red-400">*</span> son obligatorios para generar el reporte.</span>
    </div>

  </form>
</p-card>
