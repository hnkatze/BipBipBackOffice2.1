<p-drawer
  [(visible)]="visible"
  [position]="'right'"
  [modal]="true"
  styleClass="!w-full md:!w-[700px]"
  (onHide)="handleClose()"
>
  <ng-template #header>
    <div class="flex items-center gap-2">
      <i class="pi pi-shield text-xl"></i>
      <span class="font-semibold text-xl">
        {{ isEditMode() ? 'Editar Rol' : 'Crear Rol' }}
      </span>
    </div>
  </ng-template>

  <div class="flex flex-col gap-6">
    <!-- Basic Information Section -->
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-700">Información Básica</h3>

      <!-- Role Name -->
      <div class="flex flex-col gap-2">
        <label for="roleName" class="font-medium text-sm">
          Nombre del Rol <span class="text-red-500">*</span>
        </label>
        <input
          id="roleName"
          pInputText
          type="text"
          [formControl]="form.controls.roleName"
          placeholder="Ej: Administrador, Gerente, Operador"
          [class.ng-invalid]="form.controls.roleName.invalid && form.controls.roleName.touched"
          [class.ng-dirty]="form.controls.roleName.touched"
        />
        @if (form.controls.roleName.invalid && form.controls.roleName.touched) {
          <small class="text-red-500">
            @if (form.controls.roleName.errors?.['required']) {
              El nombre del rol es obligatorio
            }
            @if (form.controls.roleName.errors?.['minlength']) {
              El nombre debe tener al menos 3 caracteres
            }
          </small>
        }
      </div>

      <!-- Role Description -->
      <div class="flex flex-col gap-2">
        <label for="roleDescription" class="font-medium text-sm">
          Descripción
        </label>
        <textarea
          id="roleDescription"
          pTextarea
          [formControl]="form.controls.roleDescription"
          placeholder="Descripción del rol y sus responsabilidades..."
          [rows]="3"
          class="w-full"
        ></textarea>
      </div>
    </div>

    <p-divider />

    <!-- Permissions Section -->
    <div class="space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-700">Permisos</h3>
        <span class="text-sm text-gray-500">
          {{ selectedPermissionCount() }} permisos seleccionados
        </span>
      </div>

      @if (loading()) {
        <div class="text-center py-8">
          <i class="pi pi-spin pi-spinner text-3xl text-primary"></i>
          <p class="mt-2 text-gray-600">Cargando permisos...</p>
        </div>
      } @else {
        <!-- Permission Tree -->
        <div class="space-y-3">
          @for (module of permissionModules(); track $index; let moduleIdx = $index) {
            <div class="border rounded-lg p-4">
              <!-- Module Level (Level 1) -->
              <div class="flex items-start gap-3 mb-3">
                <p-checkbox
                  [binary]="true"
                  [ngModel]="module.active"
                  [ngModelOptions]="{standalone: true}"
                  (onChange)="toggleNode(module, null, null)"
                  [inputId]="'module-' + moduleIdx + '-' + module.id"
                />
                <label
                  [for]="'module-' + moduleIdx + '-' + module.id"
                  class="font-semibold text-gray-800 cursor-pointer flex-1"
                >
                  {{ module.name }}
                </label>
              </div>

              <!-- Submodules (Level 2) -->
              @if (module.subModules && module.subModules.length > 0) {
                <div class="ml-8 space-y-2">
                  @for (submodule of module.subModules; track $index; let subIdx = $index) {
                    <div>
                      <!-- Submodule Level -->
                      <div class="flex items-start gap-3 mb-2">
                        <p-checkbox
                          [binary]="true"
                          [ngModel]="submodule.active"
                          [ngModelOptions]="{standalone: true}"
                          (onChange)="toggleNode(submodule, module, null)"
                          [inputId]="'submodule-' + moduleIdx + '-' + subIdx + '-' + submodule.id"
                        />
                        <label
                          [for]="'submodule-' + moduleIdx + '-' + subIdx + '-' + submodule.id"
                          class="font-medium text-gray-700 cursor-pointer flex-1"
                        >
                          {{ submodule.name }}
                        </label>
                      </div>

                      <!-- Permissions (Level 3) - Only if submodule has children -->
                      @if (submodule.subModules && submodule.subModules.length > 0) {
                        <div class="ml-8 space-y-1">
                          @for (permission of submodule.subModules; track $index; let permIdx = $index) {
                            <div class="flex items-start gap-3">
                              <p-checkbox
                                [binary]="true"
                                [ngModel]="permission.active"
                                [ngModelOptions]="{standalone: true}"
                                (onChange)="toggleNode(permission, submodule, module)"
                                [inputId]="'permission-' + moduleIdx + '-' + subIdx + '-' + permIdx + '-' + permission.id"
                              />
                              <label
                                [for]="'permission-' + moduleIdx + '-' + subIdx + '-' + permIdx + '-' + permission.id"
                                class="text-sm text-gray-600 cursor-pointer flex-1"
                              >
                                {{ permission.name }}
                              </label>
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Assigned Users Section (Only in Edit Mode) -->
    @if (isEditMode() && totalUsers() > 0) {
      <p-divider />

      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-700">Usuarios Asignados</h3>
          <span class="text-sm text-gray-500">
            {{ totalUsers() }} usuario{{ totalUsers() !== 1 ? 's' : '' }}
          </span>
        </div>

        <div class="space-y-3">
          @for (user of paginatedUsers(); track user.userId) {
            <div
              class="border rounded-lg p-4 transition-all"
              [class.border-red-500]="isUserMarkedForRemoval(user.userId)"
              [class.border-2]="isUserMarkedForRemoval(user.userId)"
              [class.border-surface]="!isUserMarkedForRemoval(user.userId)"
            >
              <div class="flex items-center gap-4">
                <!-- User Avatar -->
                <div
                  class="w-12 h-12 rounded-full flex items-center justify-center font-semibold text-white"
                  [class.bg-primary]="!isUserMarkedForRemoval(user.userId)"
                  [class.bg-red-500]="isUserMarkedForRemoval(user.userId)"
                >
                  {{ getUserInitials(user.name) }}
                </div>

                <!-- User Info -->
                <div class="flex-1">
                  <h4 class="font-semibold">
                    {{ user.name || 'Sin nombre' }}
                  </h4>
                  <p class="text-sm text-muted-color">
                    {{ user.email || 'Sin email' }}
                  </p>
                  <p class="text-xs text-muted-color mt-1">
                    Asignado: {{ user.createdAt | date: 'dd/MMM/yyyy' }}
                  </p>
                </div>

                <!-- Remove Button -->
                <p-button
                  [icon]="isUserMarkedForRemoval(user.userId) ? 'pi pi-undo' : 'pi pi-times'"
                  [severity]="isUserMarkedForRemoval(user.userId) ? 'secondary' : 'danger'"
                  [outlined]="true"
                  [rounded]="true"
                  size="small"
                  [title]="isUserMarkedForRemoval(user.userId) ? 'Cancelar eliminación' : 'Quitar usuario del rol'"
                  (onClick)="toggleUserRemoval(user.userId)"
                />
              </div>

              <!-- Removal Notice -->
              @if (isUserMarkedForRemoval(user.userId)) {
                <div class="mt-3 pt-3 border-t flex items-center gap-2 text-red-500">
                  <i class="pi pi-exclamation-triangle text-sm"></i>
                  <span class="text-sm font-medium">
                    Este usuario será removido del rol
                  </span>
                </div>
              }
            </div>
          }
        </div>

        <!-- Paginator -->
        @if (totalUsers() > usersPageSize()) {
          <p-paginator
            [first]="usersPage() * usersPageSize()"
            [rows]="usersPageSize()"
            [totalRecords]="totalUsers()"
            [rowsPerPageOptions]="[5, 10, 15]"
            (onPageChange)="onUsersPageChange($event)"
          />
        }
      </div>
    }
  </div>

  <ng-template #footer>
    <div class="flex gap-2 justify-end">
      <p-button
        label="Cancelar"
        severity="secondary"
        [outlined]="true"
        (onClick)="handleClose()"
        [disabled]="loading()"
      />
      <p-button
        [label]="isEditMode() ? 'Guardar Cambios' : 'Crear Rol'"
        [loading]="loading()"
        [disabled]="form.invalid || loading()"
        (onClick)="handleSubmit()"
      />
    </div>
  </ng-template>
</p-drawer>
