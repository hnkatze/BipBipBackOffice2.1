<p-drawer
  [(visible)]="visible"
  [position]="'right'"
  [modal]="true"
  styleClass="!w-full md:!w-[700px]"
  (onHide)="handleClose()"
>
  <ng-template #header>
    <div class="flex items-center gap-2">
      <i class="pi pi-user text-xl"></i>
      <span class="font-semibold text-xl">
        {{ isEditMode() ? 'Editar Credencial' : 'Nueva Credencial' }}
      </span>
    </div>
  </ng-template>

  <div class="flex flex-col gap-6">
    <!-- Access and Role Section -->
    <div class="space-y-4">
      <h3 class="text-lg font-semibold">Datos de acceso y rol</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Left column -->
        <div class="space-y-4">
          <!-- Username -->
          <div class="flex flex-col gap-2">
            <label for="userName" class="font-medium text-sm">
              Nombre de usuario <span class="text-red-500">*</span>
            </label>
            <input
              id="userName"
              pInputText
              type="text"
              [formControl]="form.controls.userName"
              placeholder="Ingresa el nombre de usuario"
              [class.ng-invalid]="form.controls.userName.invalid && form.controls.userName.touched"
              [class.ng-dirty]="form.controls.userName.touched"
            />
            @if (form.controls.userName.invalid && form.controls.userName.touched) {
              <small class="text-red-500">
                @if (form.controls.userName.errors?.['required']) {
                  El nombre de usuario es obligatorio
                }
                @if (form.controls.userName.errors?.['minlength']) {
                  El nombre debe tener al menos 3 caracteres
                }
              </small>
            }
          </div>

          <!-- Last Name -->
          <div class="flex flex-col gap-2">
            <label for="userLastName" class="font-medium text-sm">
              Apellido
            </label>
            <input
              id="userLastName"
              pInputText
              type="text"
              [formControl]="form.controls.userLastName"
              placeholder="Ingresa el apellido"
            />
          </div>

          <!-- Role -->
          <div class="flex flex-col gap-2">
            <label for="roleId" class="font-medium text-sm">
              Rol <span class="text-red-500">*</span>
            </label>
            <p-select
              [formControl]="form.controls.roleId"
              [options]="roleOptions()"
              optionLabel="label"
              optionValue="value"
              placeholder="Selecciona un rol"
              [showClear]="false"
            />
            @if (form.controls.roleId.invalid && form.controls.roleId.touched) {
              <small class="text-red-500">
                Debes seleccionar un rol
              </small>
            }
          </div>

          <!-- Password -->
          <div class="flex flex-col gap-2">
            <label for="userPassword" class="font-medium text-sm">
              Contraseña @if (!isEditMode()) { <span class="text-red-500">*</span> }
            </label>
            <p-password
              [formControl]="form.controls.userPassword"
              placeholder="Ingresa una contraseña"
              [toggleMask]="true"
              [feedback]="false"
              autocomplete="off"
              [inputStyle]="{ width: '100%' }"
            >
              <ng-template #header>
                <div class="font-semibold text-xm mb-4">Requisitos de contraseña</div>
              </ng-template>
              <ng-template #footer>
                <p-divider />
                <ul class="pl-2 my-0 leading-normal">
                  <li>Al menos una letra minúscula</li>
                  <li>Al menos una letra mayúscula</li>
                  <li>Al menos un número</li>
                  <li>Al menos un carácter especial (!@#$%^&*...)</li>
                  <li>Mínimo 10 caracteres</li>
                </ul>
              </ng-template>
            </p-password>
            @if (form.controls.userPassword.invalid && form.controls.userPassword.touched) {
              <small class="text-red-500">
                @if (form.controls.userPassword.errors?.['required']) {
                  La contraseña es obligatoria
                }
              </small>
            }
          </div>
        </div>

        <!-- Right column - Profile Image -->
        <div class="flex flex-col items-center gap-3">
          <label class="font-medium text-sm w-full">Foto de perfil</label>

          <!-- Image preview or upload area -->
          <div class="w-full flex flex-col items-center gap-3">
            @if (imagePreview()) {
              <div class="relative">
                <img
                  [src]="imagePreview()"
                  alt="Preview"
                  class="w-32 h-32 rounded-full object-cover border-2 border-surface"
                />
                <button
                  type="button"
                  class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center"
                  (click)="removeImage()"
                >
                  <i class="pi pi-times text-xs"></i>
                </button>
              </div>
            } @else {
              <div
                class="w-full h-36 border-2 border-dashed border-surface rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-primary transition-colors"
                (click)="fileInput.click()"
              >
                <i class="pi pi-cloud-upload text-4xl text-muted-color mb-2"></i>
                <p class="text-sm text-muted-color">Cargar imagen</p>
              </div>
            }

            <input
              #fileInput
              type="file"
              accept="image/png,image/jpeg,image/jpg"
              class="hidden"
              (change)="onFileSelected($event)"
            />

            <div class="w-full surface-50 border border-surface rounded-lg p-3 flex gap-3">
              <i class="pi pi-info-circle text-primary"></i>
              <p class="text-xs text-muted-color">
                Resolución recomendada 72x72px. Formatos: PNG, JPG. Max 2MB
              </p>
            </div>

            @if (!imagePreview()) {
              <p-button
                label="Cargar imagen"
                icon="pi pi-cloud-upload"
                [outlined]="true"
                size="small"
                class="w-full"
                (onClick)="fileInput.click()"
              />
            }
          </div>
        </div>
      </div>
    </div>

    <p-divider />

    <!-- General Data Section -->
    <div class="space-y-4">
      <h3 class="text-lg font-semibold">Datos generales</h3>

      <!-- Email -->
      <div class="flex flex-col gap-2">
        <label for="userEmail" class="font-medium text-sm">
          Email <span class="text-red-500">*</span>
        </label>
        <input
          id="userEmail"
          pInputText
          type="email"
          [formControl]="form.controls.userEmail"
          placeholder="Ingresa el email"
          [class.ng-invalid]="form.controls.userEmail.invalid && form.controls.userEmail.touched"
          [class.ng-dirty]="form.controls.userEmail.touched"
        />
        @if (form.controls.userEmail.invalid && form.controls.userEmail.touched) {
          <small class="text-red-500">
            @if (form.controls.userEmail.errors?.['required']) {
              El email es obligatorio
            }
            @if (form.controls.userEmail.errors?.['email']) {
              Email inválido
            }
          </small>
        }
      </div>

      <!-- Phone -->
      <div class="flex flex-col gap-2">
        <label for="userPhone" class="font-medium text-sm">
          Teléfono
        </label>
        <input
          id="userPhone"
          pInputText
          type="text"
          [formControl]="form.controls.userPhone"
          placeholder="Ingresa el teléfono"
        />
      </div>

      <!-- Address -->
      <div class="flex flex-col gap-2">
        <label for="userAddress" class="font-medium text-sm">
          Dirección
        </label>
        <input
          id="userAddress"
          pInputText
          type="text"
          [formControl]="form.controls.userAddress"
          placeholder="Ingresa la dirección"
        />
      </div>

      <!-- Brand -->
      <div class="flex flex-col gap-2">
        <label for="brandId" class="font-medium text-sm">
          Marca
        </label>
        <p-select
          [options]="brandOptions()"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecciona una marca"
          [showClear]="true"
          [disabled]="true"
        >
          <ng-template #item let-option>
            <div class="flex items-center gap-2">
              <img [src]="option.logo" [alt]="option.label" class="w-6 h-6 object-contain" />
              <span>{{ option.label }}</span>
            </div>
          </ng-template>
        </p-select>
        <small class="text-muted-color text-xs">
          Funcionalidad próximamente
        </small>
      </div>

      <!-- Country -->
      <div class="flex flex-col gap-2">
        <label for="countryId" class="font-medium text-sm">
          País <span class="text-red-500">*</span>
        </label>
        <p-select
          [formControl]="form.controls.countryId"
          [options]="countryOptions()"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecciona un país"
          [showClear]="false"
          (onChange)="onCountryChange($event)"
        >
          <ng-template #item let-option>
            <div class="flex items-center gap-2">
              <img [src]="option.flag" [alt]="option.label" class="w-6 h-6 object-contain" />
              <span>{{ option.label }}</span>
            </div>
          </ng-template>
        </p-select>
        @if (form.controls.countryId.invalid && form.controls.countryId.touched) {
          <small class="text-red-500">
            Debes seleccionar un país
          </small>
        }
      </div>

      <!-- City -->
      <div class="flex flex-col gap-2">
        <label for="cityId" class="font-medium text-sm">
          Ciudad <span class="text-red-500">*</span>
        </label>
        <p-select
          [formControl]="form.controls.cityId"
          [options]="filteredCityOptions()"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecciona una ciudad"
          [showClear]="false"
        >
          <ng-template #item let-option>
            <div class="flex items-center gap-2">
              <img [src]="option.flag" [alt]="option.label" class="w-6 h-6 object-contain" />
              <span>{{ option.label }}</span>
            </div>
          </ng-template>
        </p-select>
        @if (form.controls.cityId.invalid && form.controls.cityId.touched) {
          <small class="text-red-500">
            Debes seleccionar una ciudad
          </small>
        }
      </div>
    </div>
  </div>

  <ng-template #footer>
    <div class="flex gap-2 justify-end">
      <p-button
        label="Cancelar"
        severity="secondary"
        [outlined]="true"
        (onClick)="handleClose()"
        [disabled]="loading()"
      />
      <p-button
        [label]="isEditMode() ? 'Guardar Cambios' : 'Crear Credencial'"
        [loading]="loading()"
        [disabled]="form.invalid || loading()"
        (onClick)="handleSubmit()"
      />
    </div>
  </ng-template>
</p-drawer>
