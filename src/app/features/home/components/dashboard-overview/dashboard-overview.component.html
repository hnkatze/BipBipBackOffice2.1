<div class="dashboard-overview">
  <!-- Filtros -->
  <div class="filters-section mb-4">
    <form [formGroup]="filtersForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <!-- Select de Ciudad -->
      <div class="filter-item">
        <label for="city-select" class="block mb-2 font-semibold">Ciudad</label>
        <p-select
          inputId="city-select"
          formControlName="selectedCity"
          [options]="cities()"
          optionLabel="name"
          placeholder="Seleccionar ciudad"
          class="w-full"
        />
      </div>

      <!-- Select de Rango Predefinido -->
      <div class="filter-item">
        <label for="range-select" class="block mb-2 font-semibold">Periodo</label>
        <p-select
          inputId="range-select"
          formControlName="selectedDateRange"
          [options]="dateRangeOptions()"
          optionLabel="label"
          placeholder="Seleccionar periodo"
          class="w-full"
          (onChange)="onDateRangeChange()"
        />
      </div>

      <!-- Filtro de Fecha Manual -->
      <div class="filter-item">
        <label for="date-filter" class="block mb-2 font-semibold">Fechas Personalizadas</label>
        <p-datepicker
          inputId="date-filter"
          formControlName="dateRange"
          selectionMode="range"
          [showIcon]="true"
          iconDisplay="input"
          placeholder="Seleccionar fechas"
          class="w-full"
          (onSelect)="onManualDateChange()"
        />
      </div>

      <!-- Botones de acción -->
      <div class="filter-item flex items-end gap-2">
        <p-button
          label="Aplicar"
          icon="pi pi-filter"
          (click)="applyFilters()"
          [loading]="isLoading()"
          styleClass="flex-1"
        />
        <p-button
          label="Limpiar"
          icon="pi pi-times"
          (click)="clearFilters()"
          [disabled]="isLoading()"
          severity="secondary"
          [outlined]="true"
        />
      </div>
    </form>

    <!-- Mensaje de error -->
    @if (error()) {
      <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded mb-4">
        <div class="flex items-center gap-2">
          <i class="pi pi-exclamation-triangle"></i>
          <span>{{ error() }}</span>
        </div>
      </div>
    }
  </div>

  <!-- KPIs de Órdenes -->
  <div class="kpis-section mb-4">
    <h3 class="text-lg font-semibold mb-3">Resumen de Órdenes</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      @if (isLoading()) {
        @for (i of [1, 2, 3]; track i) {
          <p-card styleClass="kpi-card">
            <div class="flex justify-between items-center">
              <div class="flex-1">
                <p-skeleton width="60%" height="1rem" styleClass="mb-2" />
                <p-skeleton width="40%" height="2.5rem" />
              </div>
              <div class="kpi-icon">
                <p-skeleton shape="circle" size="3rem" />
              </div>
            </div>
          </p-card>
        }
      } @else {
        @for (kpi of orderKpis(); track kpi.label) {
          <p-card styleClass="kpi-card">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">{{ kpi.label }}</p>
                <p class="text-3xl font-bold">{{ formatNumber(kpi.value) }}</p>
              </div>
              @if (kpi.icon) {
                <div class="kpi-icon">
                  <i [class]="kpi.icon + ' text-4xl text-primary-500'"></i>
                </div>
              }
            </div>
          </p-card>
        }
      }
    </div>
  </div>

  <!-- KPIs de Costos de Envío -->
  <div class="kpis-section mb-4">
    <h3 class="text-lg font-semibold mb-3">Métricas de Envío</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
      @if (isLoading()) {
        @for (i of [1, 2, 3, 4, 5]; track i) {
          <p-card styleClass="kpi-card">
            <div class="flex justify-between items-center">
              <div class="flex-1">
                <p-skeleton width="80%" height="0.875rem" styleClass="mb-2" />
                <p-skeleton width="60%" height="1.5rem" />
              </div>
            </div>
          </p-card>
        }
      } @else {
        @for (kpi of shippingKpis(); track kpi.label) {
          <p-card styleClass="kpi-card">
            <div class="flex flex-col">
              <div class="flex items-center gap-2 mb-2">
                @if (kpi.icon) {
                  <i [class]="kpi.icon + ' text-lg text-primary-500'"></i>
                }
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ kpi.label }}</p>
              </div>
              <p class="text-2xl font-bold">{{ formatCurrency(kpi.value) }}</p>
            </div>
          </p-card>
        }
      }
    </div>
  </div>

  <!-- KPIs de Ventas -->
  <div class="kpis-section mb-4">
    <h3 class="text-lg font-semibold mb-3">Métricas de Ventas</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      @if (isLoading()) {
        @for (i of [1, 2]; track i) {
          <p-card styleClass="kpi-card">
            <div class="flex justify-between items-center">
              <div class="flex-1">
                <p-skeleton width="60%" height="1rem" styleClass="mb-2" />
                <p-skeleton width="40%" height="2.5rem" />
              </div>
              <div class="kpi-icon">
                <p-skeleton shape="circle" size="3rem" />
              </div>
            </div>
          </p-card>
        }
      } @else {
        @for (kpi of salesKpis(); track kpi.label) {
          <p-card styleClass="kpi-card">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">{{ kpi.label }}</p>
                <p class="text-3xl font-bold">
                  @if (kpi.label === 'Ticket Promedio') {
                    {{ formatCurrency(kpi.value) }}
                  } @else {
                    {{ formatNumber(kpi.value) }}
                  }
                </p>
              </div>
              @if (kpi.icon) {
                <div class="kpi-icon">
                  <i [class]="kpi.icon + ' text-4xl text-primary-500'"></i>
                </div>
              }
            </div>
          </p-card>
        }
      }
    </div>
  </div>

  <!-- KPIs de Clientes -->
  <div class="kpis-section mb-4">
    <h3 class="text-lg font-semibold mb-3">Métricas de Clientes</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      @if (isLoading()) {
        <p-card styleClass="kpi-card">
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <p-skeleton width="60%" height="1rem" styleClass="mb-2" />
              <p-skeleton width="40%" height="2.5rem" />
            </div>
            <div class="kpi-icon">
              <p-skeleton shape="circle" size="3rem" />
            </div>
          </div>
        </p-card>
      } @else {
        @for (kpi of customerKpis(); track kpi.label) {
          <p-card styleClass="kpi-card">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">{{ kpi.label }}</p>
                <p class="text-3xl font-bold">{{ formatPercentage(kpi.value) }}</p>
              </div>
              @if (kpi.icon) {
                <div class="kpi-icon">
                  <i [class]="kpi.icon + ' text-4xl text-primary-500'"></i>
                </div>
              }
            </div>
          </p-card>
        }
      }
    </div>
  </div>

  <!-- Tabla y Gráfico -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <!-- Tabla de Órdenes por Método de Pago -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="flex justify-between items-center p-4">
          <h3 class="text-lg font-semibold m-0">Órdenes Por Método De Pago</h3>
          <button
            pButton
            icon="pi pi-ellipsis-v"
            class="p-button-text p-button-rounded"
          ></button>
        </div>
      </ng-template>

      @if (isLoading()) {
        <div class="p-4">
          @for (i of [1, 2, 3, 4]; track i) {
            <div class="flex justify-between mb-3">
              <p-skeleton width="40%" height="1.5rem" />
              <p-skeleton width="20%" height="1.5rem" />
            </div>
          }
        </div>
      } @else if (dashboardData()) {
        <p-table
          [value]="dashboardData()!.ordersByPaymentMethod"
          [tableStyle]="{ 'min-width': '100%' }"
          [paginator]="dashboardData()!.ordersByPaymentMethod.length > 6"
          [rows]="6"
          [rowsPerPageOptions]="[6, 12, 24]"
          styleClass="payment-methods-table"
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="font-semibold">Método de pago</th>
              <th class="text-right font-semibold">Total de pedidos</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
            <tr class="table-row-hover">
              <td>
                <div class="flex items-center gap-2">
                  <span >{{ item.method }}</span>
                </div>
              </td>
              <td class="text-right font-semibold">{{ formatNumber(item.total) }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td class="font-bold text-primary-600 dark:text-primary-400">Total</td>
              <td class="text-right font-bold text-primary-600 dark:text-primary-400">
                {{ formatNumber(dashboardData()!.totalOrders) }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      }
    </p-card>

    <!-- Gráfico de Órdenes por Canal -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="flex justify-between items-center p-4">
          <h3 class="text-lg font-semibold m-0">Órdenes Por Canal</h3>
          <button
            pButton
            icon="pi pi-ellipsis-v"
            class="p-button-text p-button-rounded"
          ></button>
        </div>
      </ng-template>

      @if (isLoading()) {
        <div class="p-4 flex flex-col items-center">
          <p-skeleton shape="circle" size="12rem" styleClass="mb-4" />
          <div class="w-full">
            @for (i of [1, 2, 3, 4]; track i) {
              <div class="flex items-center gap-2 mb-2">
                <p-skeleton shape="circle" size="1rem" />
                <p-skeleton width="70%" height="1rem" />
              </div>
            }
          </div>
        </div>
      } @else if (chartData()) {
        <div class="chart-container">
          <div class="chart-wrapper">
            <p-chart
              type="doughnut"
              [data]="chartData()!"
              [options]="chartOptions"
              styleClass="chart-canvas"
            />
          </div>

          <!-- Leyendas custom -->
          <div class="chart-legends">
            @for (legend of chartLegends(); track legend.label) {
              <div class="legend-item">
                <span class="legend-color" [style.background-color]="legend.color"></span>
                <span class="legend-text">{{ legend.label }} ({{ legend.percentage }}%)</span>
              </div>
            }
          </div>
        </div>
      }
    </p-card>
  </div>

  <!-- Tablas de Órdenes por Marca y Ciudad -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-5">
    <!-- Tabla de Órdenes por Marca -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="flex justify-between items-center p-4">
          <h3 class="text-lg font-semibold m-0">Órdenes Por Marcas</h3>
          <button
            pButton
            icon="pi pi-ellipsis-v"
            class="p-button-text p-button-rounded"
          ></button>
        </div>
      </ng-template>

      @if (isLoading()) {
        <div class="p-4">
          @for (i of [1, 2, 3, 4]; track i) {
            <div class="flex justify-between items-center mb-3">
              <p-skeleton width="30%" height="1.5rem" />
              <p-skeleton width="3rem" height="2rem" />
              <p-skeleton width="20%" height="1.5rem" />
            </div>
          }
        </div>
      } @else if (dashboardData()) {
        <p-table
          [value]="dashboardData()!.ordersByBrand"
          [tableStyle]="{ 'min-width': '100%' }"
          [paginator]="dashboardData()!.ordersByBrand.length > 6"
          [rows]="6"
          [rowsPerPageOptions]="[6, 12, 24]"
          styleClass="payment-methods-table"
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="font-semibold">Marca</th>
              <th class="font-semibold">Logo</th>
              <th class="text-right font-semibold">Total de pedidos</th>
              <th class="text-right font-semibold">Ingresos</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.brandName }}</td>
              <td>
                @if (item.logo) {
                  <img [src]="item.logo" [alt]="item.brandName" class="h-8 w-auto object-contain" />
                }
              </td>
              <td class="text-right font-semibold">{{ formatNumber(item.total) }}</td>
              <td class="text-right font-semibold">
                @if (item.totalRevenue !== undefined) {
                  {{ formatCurrency(item.totalRevenue) }}
                } @else {
                  <span class="text-gray-400">-</span>
                }
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td colspan="2" class="font-bold text-primary-600 dark:text-primary-400">Total</td>
              <td class="text-right font-bold text-primary-600 dark:text-primary-400">
                {{ formatNumber(getTotalByBrand()) }}
              </td>
              <td class="text-right font-bold text-primary-600 dark:text-primary-400">
                {{ formatCurrency(getTotalRevenueByBrand()) }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      }
    </p-card>

    <!-- Tabla de Órdenes por Ciudad -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="flex justify-between items-center p-4">
          <h3 class="text-lg font-semibold m-0">Órdenes Por Ciudad</h3>
          <button
            pButton
            icon="pi pi-ellipsis-v"
            class="p-button-text p-button-rounded"
          ></button>
        </div>
      </ng-template>

      @if (isLoading()) {
        <div class="p-4">
          @for (i of [1, 2, 3, 4]; track i) {
            <div class="flex justify-between mb-3">
              <p-skeleton width="40%" height="1.5rem" />
              <p-skeleton width="20%" height="1.5rem" />
            </div>
          }
        </div>
      } @else if (dashboardData()) {
        <p-table
          [value]="dashboardData()!.ordersByCity"
          [tableStyle]="{ 'min-width': '100%' }"
          [paginator]="dashboardData()!.ordersByCity.length > 6"
          [rows]="6"
          [rowsPerPageOptions]="[6, 12, 24]"
          styleClass="payment-methods-table"
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="font-semibold">Ciudad</th>
              <th class="text-right font-semibold">Total de pedidos</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.cityName }}</td>
              <td class="text-right font-semibold">{{ formatNumber(item.total) }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td class="font-bold text-primary-600 dark:text-primary-400">Total</td>
              <td class="text-right font-bold text-primary-600 dark:text-primary-400">
                {{ formatNumber(getTotalByCity()) }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      }
    </p-card>
  </div>
</div>
