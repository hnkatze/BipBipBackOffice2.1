<!-- Toast para notificaciones -->
<p-toast />

<!-- Breadcrumb -->
<p-breadcrumb [model]="breadcrumbItems" [home]="breadcrumbHome" styleClass="mb-4" />

<!-- Header -->
<div class="mb-6">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
    Tipos de Documento
  </h1>
  <p class="text-gray-600 dark:text-gray-400">
    Gestión de tipos de documento para facturación
  </p>
</div>

<!-- Toolbar: Filtros + Búsqueda + Botón Crear -->
<div class="mb-6 space-y-4">
  <!-- Filtros de estado -->
  <div class="flex flex-wrap gap-2">
    @for (filter of statusFilters(); track filter.idStatus) {
      <p-button
        [label]="filter.label + ' (' + filter.qty + ')'"
        [severity]="activeStatusFilter().idStatus === filter.idStatus ? undefined : 'secondary'"
        [outlined]="activeStatusFilter().idStatus !== filter.idStatus"
        size="small"
        (onClick)="onStatusFilterChange(filter)"
      />
    }
  </div>

  <!-- Búsqueda + Botón Crear -->
  <div class="flex flex-col sm:flex-row gap-3">
    <!-- Input de búsqueda con iconos -->
    <div class="flex-1">
      <p-iconfield iconPosition="left">
        <p-inputicon>
          <i class="pi pi-search"></i>
        </p-inputicon>
        <input
          type="text"
          pInputText
          [(ngModel)]="searchInput"
          (keyup.enter)="onSearch()"
          placeholder="Buscar por nombre..."
          class="w-full"
        />
      </p-iconfield>
    </div>

    <!-- Botón Crear (Primary = Rojo de marca) -->
    <p-button
      label="Crear Tipo de Documento"
      icon="pi pi-plus"
      (onClick)="openCreateDrawer()"
    />
  </div>
</div>

<!-- Tabla (Desktop/Tablet) -->
<div class="hidden md:block bg-white dark:bg-gray-800 rounded-lg shadow">
  <p-table
    [value]="documentTypes()"
    [loading]="isLoading()"
    [paginator]="true"
    [rows]="pageSize()"
    [totalRecords]="totalRecords()"
    [lazy]="true"
    (onLazyLoad)="onPageChange($event)"
    [first]="currentPage() * pageSize()"
    [rowsPerPageOptions]="[5, 10, 20]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
    [pt]="{ root: { class: 'p-datatable-sm' } }"
    [tableStyle]="{ 'min-width': '50rem' }"
  >
    <!-- Loading template -->
    <ng-template pTemplate="loadingbody">
      <tr>
        <td colspan="5" class="text-center py-8">
          <i class="pi pi-spin pi-spinner text-3xl text-gray-400"></i>
          <p class="mt-2 text-gray-500">Cargando...</p>
        </td>
      </tr>
    </ng-template>

    <!-- Empty template -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center py-8">
          <i class="pi pi-inbox text-4xl text-gray-400"></i>
          <p class="mt-2 text-gray-500">No se encontraron tipos de documento</p>
        </td>
      </tr>
    </ng-template>

    <!-- Header -->
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="docTypeNumb">
          <div class="flex items-center gap-2">
            Código
            <p-sortIcon field="docTypeNumb" />
          </div>
        </th>
        <th pSortableColumn="docTypeName">
          <div class="flex items-center gap-2">
            Nombre
            <p-sortIcon field="docTypeName" />
          </div>
        </th>
        <th class="text-center">Estado</th>
        <th class="text-center">Acciones</th>
      </tr>
    </ng-template>

    <!-- Body -->
    <ng-template pTemplate="body" let-documentType>
      <tr>
        <!-- Código -->
        <td>
          <span class="font-semibold text-gray-900 dark:text-white">
            {{ documentType.docTypeNumb }}
          </span>
        </td>

        <!-- Nombre -->
        <td>
          <span class="text-gray-700 dark:text-gray-300">
            {{ documentType.docTypeName }}
          </span>
        </td>

        <!-- Estado con toggle -->
        <td class="text-center">
          <div class="flex items-center justify-center gap-3">
            <p-tag
              [value]="documentType.isActive ? 'Activo' : 'Inactivo'"
              [severity]="getStatusSeverity(documentType.isActive)"
            />
            <p-toggleSwitch
              [ngModel]="documentType.isActive"
              (ngModelChange)="onStatusToggle(documentType)"
            />
          </div>
        </td>

        <!-- Acciones -->
        <td class="text-center">
          <p-button
            icon="pi pi-pencil"
            severity="secondary"
            [outlined]="true"
            size="small"
            [rounded]="true"
            (onClick)="openEditDrawer(documentType)"
            pTooltip="Editar"
            tooltipPosition="top"
          />
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Mobile Cards -->
<div class="block md:hidden">
  @if (isLoading()) {
    <!-- Loading Skeleton -->
    <div class="flex flex-col gap-4">
      @for (item of [1, 2, 3]; track item) {
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
          <p-skeleton width="100%" height="10rem" />
        </div>
      }
    </div>
  } @else {
    <!-- Empty State -->
    @if (documentTypes().length === 0) {
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-8">
        <div class="flex flex-col items-center justify-center text-gray-500 dark:text-gray-400">
          <i class="pi pi-inbox text-4xl mb-3"></i>
          <p class="text-lg font-medium">No se encontraron tipos de documento</p>
        </div>
      </div>
    }

    <!-- Cards List -->
    @if (documentTypes().length > 0) {
      <div class="flex flex-col gap-4">
        @for (documentType of documentTypes(); track documentType.docTypeId) {
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
            <!-- Header: Código + Nombre + Estado -->
            <div class="flex items-start gap-3 mb-3 pb-3 border-b border-gray-200 dark:border-gray-700">
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-900 dark:text-white">{{ documentType.docTypeName }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Código: {{ documentType.docTypeNumb }}</div>
              </div>
              <div class="flex-shrink-0">
                <p-tag
                  [value]="documentType.isActive ? 'Activo' : 'Inactivo'"
                  [severity]="getStatusSeverity(documentType.isActive)"
                />
              </div>
            </div>

            <!-- Acciones -->
            <div class="flex items-center gap-2 pt-3 border-t border-gray-200 dark:border-gray-700">
              <p-button
                label="Editar"
                icon="pi pi-pencil"
                size="small"
                [outlined]="true"
                severity="secondary"
                (onClick)="openEditDrawer(documentType)"
                styleClass="flex-1"
              />
              <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500 dark:text-gray-400">Estado:</span>
                <p-toggleSwitch
                  [ngModel]="documentType.isActive"
                  (ngModelChange)="onStatusToggle(documentType)"
                />
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Paginador Mobile -->
      <div class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
        <p-paginator
          [rows]="pageSize()"
          [totalRecords]="totalRecords()"
          [first]="currentPage() * pageSize()"
          [rowsPerPageOptions]="[5, 10, 20]"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
          (onPageChange)="onPageChange($event)"
        />
      </div>
    }
  }
</div>

<!-- Drawer de formulario -->
@if (showDrawer()) {
  <app-document-type-form
    [documentTypeId]="selectedDocumentTypeId()"
    (onClose)="closeDrawer()"
    (onSave)="onSaveSuccess()"
  />
}
