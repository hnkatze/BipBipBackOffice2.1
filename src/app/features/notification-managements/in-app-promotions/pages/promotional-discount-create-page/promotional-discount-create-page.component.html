<!-- Header -->
<div class="mb-6">
  <div class="flex items-center gap-3 mb-2">
    <p-button
      icon="pi pi-arrow-left"
      [rounded]="true"
      [text]="true"
      severity="secondary"
      (onClick)="onCancel()"
      pTooltip="Regresar"
      tooltipPosition="bottom" />
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white m-0">Nuevo Descuento Promocional</h1>
  </div>
  <p class="text-gray-600 dark:text-gray-400">
    Crea un descuento automático aplicado globalmente según marcas, canales y ciudades
  </p>
</div>

<!-- Form -->
<form [formGroup]="form" class="flex flex-col gap-6">

  <!-- Sección: Tipo de Descuento -->
  <p-card header="Tipo de Descuento">
    <div class="grid grid-cols-1 gap-4">
      <!-- Discount Type -->
      <div class="flex flex-col gap-2">
        <label for="discountType" class="font-medium text-gray-900 dark:text-white">
          Tipo de Descuento <span class="text-danger-500">*</span>
        </label>
        <p-select id="discountType" formControlName="discountType"
          [options]="discountTypeOptions" optionLabel="label" optionValue="value"
          placeholder="Seleccione tipo" />
        @if (hasError('discountType')) {
          <small class="text-danger-500">{{ getErrorMessage('discountType') }}</small>
        }
      </div>

      <!-- Discount Value (Condicional: si type = FixedDiscount o PercentageDiscount) -->
      @if (showDiscountValue()) {
        <div class="flex flex-col gap-2">
          <label for="discountValue" class="font-medium text-gray-900 dark:text-white">
            @if (isPercentage()) {
              Porcentaje de Descuento <span class="text-danger-500">*</span>
            } @else if (isFixedDiscount()) {
              Monto de Descuento <span class="text-danger-500">*</span>
            }
          </label>
          <p-inputnumber id="discountValue" formControlName="discountValue"
            [min]="0"
            [max]="isPercentage() ? 100 : 999999"
            [suffix]="isPercentage() ? '%' : ' L'"
            [showButtons]="true"
            [step]="isPercentage() ? 1 : 10"
            placeholder="0" />
          @if (hasError('discountValue')) {
            <small class="text-danger-500">{{ getErrorMessage('discountValue') }}</small>
          }
          @if (isPercentage()) {
            <small class="text-gray-500">Ingrese el porcentaje de descuento (1-100)</small>
          } @else if (isFixedDiscount()) {
            <small class="text-gray-500">Ingrese el monto fijo de descuento en Lempiras</small>
          }
        </div>
      }

      <!-- Delivery Cost (Condicional: si type = DeliveryCost) -->
      @if (showDeliveryCost()) {
        <div class="flex flex-col gap-2">
          <label for="deliveryCost" class="font-medium text-gray-900 dark:text-white">
            Costo de Entrega <span class="text-danger-500">*</span>
          </label>
          <p-inputnumber id="deliveryCost" formControlName="deliveryCost"
            [min]="0"
            suffix=" L"
            [showButtons]="true"
            [step]="5"
            placeholder="0" />
          @if (hasError('deliveryCost')) {
            <small class="text-danger-500">{{ getErrorMessage('deliveryCost') }}</small>
          }
          <small class="text-gray-500">Ingrese el costo de entrega fijo en Lempiras</small>
        </div>
      }
    </div>
  </p-card>

  <!-- Sección: Fechas y Disponibilidad -->
  <p-card header="Fechas y Disponibilidad">
    <div class="grid grid-cols-1 gap-4">
      <!-- Fechas -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Start Date -->
        <div class="flex flex-col gap-2">
          <label for="startDate" class="font-medium text-gray-900 dark:text-white">
            Fecha de Inicio <span class="text-danger-500">*</span>
          </label>
          <p-datepicker id="startDate" formControlName="startDate"
            dateFormat="dd/mm/yy" [showIcon]="true" [showTime]="true" />
          @if (hasError('startDate')) {
            <small class="text-danger-500">{{ getErrorMessage('startDate') }}</small>
          }
        </div>

        <!-- End Date -->
        <div class="flex flex-col gap-2">
          <label for="endDate" class="font-medium text-gray-900 dark:text-white">
            Fecha de Fin <span class="text-danger-500">*</span>
          </label>
          <p-datepicker id="endDate" formControlName="endDate"
            dateFormat="dd/mm/yy" [showIcon]="true" [showTime]="true" />
          @if (hasError('endDate')) {
            <small class="text-danger-500">{{ getErrorMessage('endDate') }}</small>
          }
        </div>
      </div>

      <!-- Brands -->
      <div class="flex flex-col gap-2">
        <label for="availableBrands" class="font-medium text-gray-900 dark:text-white">
          Marcas Disponibles <span class="text-danger-500">*</span>
        </label>
        <p-multiselect id="availableBrands" formControlName="availableBrands"
          [options]="brandsOptions()" optionLabel="name" optionValue="id"
          placeholder="Seleccione marcas" display="chip" [filter]="true"
          filterPlaceholder="Buscar marca..." />
        @if (hasError('availableBrands')) {
          <small class="text-danger-500">{{ getErrorMessage('availableBrands') }}</small>
        }
        <small class="text-gray-500">Debe seleccionar al menos una marca</small>
      </div>

      <!-- Channels -->
      <div class="flex flex-col gap-2">
        <label for="availableChannels" class="font-medium text-gray-900 dark:text-white">
          Canales Disponibles <span class="text-danger-500">*</span>
        </label>
        <p-multiselect id="availableChannels" formControlName="availableChannels"
          [options]="channelsOptions()" optionLabel="description" optionValue="id"
          placeholder="Seleccione canales" display="chip" [filter]="true"
          filterPlaceholder="Buscar canal..." />
        @if (hasError('availableChannels')) {
          <small class="text-danger-500">{{ getErrorMessage('availableChannels') }}</small>
        }
        <small class="text-gray-500">Debe seleccionar al menos un canal</small>
      </div>

      <!-- Cities -->
      <div class="flex flex-col gap-2">
        <label for="availableCities" class="font-medium text-gray-900 dark:text-white">
          Ciudades Disponibles <span class="text-danger-500">*</span>
        </label>
        <p-multiselect id="availableCities" formControlName="availableCities"
          [options]="citiesOptions()" optionLabel="name" optionValue="id"
          placeholder="Seleccione ciudades" display="chip" [filter]="true"
          filterPlaceholder="Buscar ciudad..." />
        @if (hasError('availableCities')) {
          <small class="text-danger-500">{{ getErrorMessage('availableCities') }}</small>
        }
        <small class="text-gray-500">Debe seleccionar al menos una ciudad</small>
      </div>

      <!-- Info sobre estado -->
      <div class="flex items-start gap-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
        <i class="pi pi-info-circle text-blue-600 dark:text-blue-400 mt-1"></i>
        <div class="flex flex-col gap-1">
          <span class="font-medium text-blue-900 dark:text-blue-100">Estado inicial</span>
          <span class="text-sm text-blue-700 dark:text-blue-300">
            El descuento se creará en estado <strong>desactivado</strong>.
            Para activarlo, ve a la tabla y cambia su estado manualmente.
          </span>
        </div>
      </div>
    </div>
  </p-card>

  <!-- Botones de Acción -->
  <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
    <p-button label="Cancelar" [outlined]="true" severity="secondary"
      (onClick)="onCancel()" [disabled]="isSaving()" />
    <p-button label="Crear Descuento Promocional" icon="pi pi-check"
      (onClick)="onSubmit()" [loading]="isSaving()" [disabled]="form.invalid" />
  </div>
</form>

<!-- Toast para notificaciones -->
<p-toast />
