<!-- Loading State -->
@if (isLoading()) {
  <div class="flex justify-center items-center h-64">
    <i class="pi pi-spin pi-spinner text-4xl text-primary-500"></i>
  </div>
} @else {
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center gap-3 mb-2">
      <p-button
        icon="pi pi-arrow-left"
        [rounded]="true"
        [text]="true"
        severity="secondary"
        (onClick)="onCancel()"
        pTooltip="Regresar"
        tooltipPosition="bottom" />
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white m-0">{{ pageTitle() }}</h1>
    </div>
    <p class="text-gray-600 dark:text-gray-400">
      @if (isEditMode()) {
        Modifica la configuración de la recompensa automática
      } @else {
        Crea una recompensa automática que se activa al comprar productos específicos
      }
    </p>
  </div>

  <!-- Form -->
  <form [formGroup]="form" class="flex flex-col gap-6">

  <!-- Sección: Configuración Básica -->
  <p-card header="Configuración Básica">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Trigger Type -->
      <div class="flex flex-col gap-2">
        <label for="triggerId" class="font-medium text-gray-900 dark:text-white">
          Tipo de Disparador <span class="text-danger-500">*</span>
        </label>
        <p-select id="triggerId" formControlName="triggerId"
          [options]="triggerTypeOptions" optionLabel="label" optionValue="value"
          placeholder="Seleccione tipo de disparador" />
        @if (hasError('triggerId')) {
          <small class="text-danger-500">{{ getErrorMessage('triggerId') }}</small>
        }
        <small class="text-gray-500">Define cuándo se activa la recompensa</small>
      </div>

      <!-- Brand (solo si trigger != Producto) -->
      @if (!showProductTrigger()) {
        <div class="flex flex-col gap-2">
          <label for="brandId" class="font-medium text-gray-900 dark:text-white">
            Marca <span class="text-danger-500">*</span>
          </label>
          <p-select id="brandId" formControlName="brandId"
            [options]="brandsOptions()" optionLabel="name" optionValue="id"
            placeholder="Seleccione marca" [filter]="true"
            filterPlaceholder="Buscar marca..." />
          @if (hasError('brandId')) {
            <small class="text-danger-500">{{ getErrorMessage('brandId') }}</small>
          }
        </div>
      }

      <!-- Reward Type -->
      <div class="flex flex-col gap-2" [class.md:col-span-2]="!showProductTrigger()">
        <label for="rewardType" class="font-medium text-gray-900 dark:text-white">
          Tipo de Recompensa <span class="text-danger-500">*</span>
        </label>
        <p-select id="rewardType" formControlName="rewardType"
          [options]="rewardTypeOptions" optionLabel="label" optionValue="value"
          placeholder="Seleccione tipo de recompensa" />
        @if (hasError('rewardType')) {
          <small class="text-danger-500">{{ getErrorMessage('rewardType') }}</small>
        }
        <small class="text-gray-500">Define qué obtiene el cliente como recompensa</small>
      </div>
    </div>
  </p-card>

  <!-- Sección: Producto Disparador (solo si trigger = 1) -->
  @if (showProductTrigger()) {
    <p-card header="Producto Disparador">
      <!-- Product Selector Component -->
      <app-simple-product-selector
        [form]="form"
        [brandsData]="brands()"
        brandFieldName="brandId"
        productFieldName="productCode"
        brandLabel="Marca"
        productLabel="Producto Disparador"
        brandPlaceholder="Seleccione marca"
        productPlaceholder="Seleccione producto"
        brandHelperText="Marca del producto que activa la recompensa"
        productHelperText="Producto que activa la recompensa"
        (productSelected)="onTriggerProductSelected($event)" />

      <!-- Modifier Selector (opcional) -->
      <div class="mt-4">
        <app-simple-modifier-selector
          [control]="$any(form.controls['modifierCode'])"
          [productId]="selectedTriggerProduct()?.productId || ''"
          [brandCode]="selectedTriggerProduct()?.brand || ''"
          fieldId="modifierCode"
          label="Modificadores del Producto Disparador (Opcional)"
          placeholder="Seleccione modificadores"
          helperText="Modificadores específicos del producto que activa la recompensa" />
      </div>
    </p-card>
  }

  <!-- Sección: Canal (solo si trigger = 2) -->
  @if (showChannelSelector()) {
    <p-card header="Canal">
      <div class="grid grid-cols-1 gap-4">
        <div class="flex flex-col gap-2">
          <label for="channelId" class="font-medium text-gray-900 dark:text-white">
            Canal (Opcional)
          </label>
          <p-select id="channelId" formControlName="channelId"
            [options]="channelsOptions()" optionLabel="description" optionValue="id"
            placeholder="Seleccione canal" [filter]="true"
            filterPlaceholder="Buscar canal..." />
          <small class="text-gray-500">Canal específico donde aplica la recompensa</small>
        </div>
      </div>
    </p-card>
  }

  <!-- Sección: Restricciones (solo si trigger = 2 o 3) -->
  @if (showConstraints()) {
    <p-card header="Restricciones">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Constraint Type (solo hay uno) -->
        <div class="flex flex-col gap-2 md:col-span-2">
          <label for="constraintType" class="font-medium text-gray-900 dark:text-white">
            Tipo de Restricción
          </label>
          <input pInputText id="constraintType" value="Compra Mínima" [disabled]="true" />
          <small class="text-gray-500">Actualmente solo se soporta restricción por compra mínima</small>
        </div>

        <!-- Minimum Purchase Value -->
        <div class="flex flex-col gap-2">
          <label for="minimumPurchaseValue" class="font-medium text-gray-900 dark:text-white">
            Valor Mínimo de Compra <span class="text-danger-500">*</span>
          </label>
          <p-inputnumber id="minimumPurchaseValue" formControlName="minimumPurchaseValue"
            [min]="0" suffix=" L" [showButtons]="true" [step]="10" placeholder="0" />
          @if (hasError('minimumPurchaseValue')) {
            <small class="text-danger-500">{{ getErrorMessage('minimumPurchaseValue') }}</small>
          }
          <small class="text-gray-500">Monto mínimo para aplicar la recompensa</small>
        </div>

        <!-- Constraint Date From -->
        <div class="flex flex-col gap-2">
          <label for="constraintDateFrom" class="font-medium text-gray-900 dark:text-white">
            Fecha Inicio Restricción (Opcional)
          </label>
          <p-datepicker id="constraintDateFrom" formControlName="constraintDateFrom"
            dateFormat="dd/mm/yy" [showIcon]="true" [showTime]="true" />
          <small class="text-gray-500">Inicio del período de restricción</small>
        </div>

        <!-- Constraint Date To -->
        <div class="flex flex-col gap-2">
          <label for="constraintDateTo" class="font-medium text-gray-900 dark:text-white">
            Fecha Fin Restricción (Opcional)
          </label>
          <p-datepicker id="constraintDateTo" formControlName="constraintDateTo"
            dateFormat="dd/mm/yy" [showIcon]="true" [showTime]="true" />
          <small class="text-gray-500">Fin del período de restricción</small>
        </div>

        <!-- Constraint Is Active -->
        <div class="flex items-center gap-3">
          <p-toggleswitch formControlName="constraintIsActive" inputId="constraintIsActive" />
          <label for="constraintIsActive" class="font-medium cursor-pointer text-gray-900 dark:text-white">
            Restricción Activa
          </label>
        </div>
      </div>
    </p-card>
  }

  <!-- Sección: Producto de Recompensa (solo si reward = 1) -->
  @if (showProductReward()) {
    <p-card header="Producto de Recompensa">
      <!-- Product Selector Component -->
      <app-simple-product-selector
        [form]="form"
        [brandsData]="brands()"
        brandFieldName="brandId"
        productFieldName="productToReward"
        brandLabel="Marca"
        productLabel="Producto de Recompensa"
        brandPlaceholder="Seleccione marca"
        productPlaceholder="Seleccione producto gratis"
        brandHelperText="Marca del producto que se regala"
        productHelperText="Producto que se regala como recompensa"
        (productSelected)="onRewardProductSelected($event)" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <!-- Product To Reward Qty -->
        <div class="flex flex-col gap-2">
          <label for="productToRewardQty" class="font-medium text-gray-900 dark:text-white">
            Cantidad <span class="text-danger-500">*</span>
          </label>
          <p-inputnumber id="productToRewardQty" formControlName="productToRewardQty"
            [min]="1" [showButtons]="true" placeholder="1" />
          @if (hasError('productToRewardQty')) {
            <small class="text-danger-500">{{ getErrorMessage('productToRewardQty') }}</small>
          }
          <small class="text-gray-500">Cantidad de productos gratis que se regalan</small>
        </div>

        <!-- Modifiers To Reward (usando el componente) -->
        <div class="flex flex-col gap-2">
          <app-simple-modifier-selector
            [control]="$any(form.controls['modifiersToReward'])"
            [productId]="selectedRewardProduct()?.productId || ''"
            [brandCode]="selectedRewardProduct()?.brand || ''"
            fieldId="modifiersToReward"
            label="Modificadores del Producto de Recompensa (Opcional)"
            placeholder="Seleccione modificadores"
            helperText="Modificadores del producto que se regala" />
        </div>
      </div>
    </p-card>
  }

  <!-- Sección: Descuento en Envío (solo si reward = 2) -->
  @if (showDeliveryCharge()) {
    <p-card header="Descuento en Envío">
      <div class="grid grid-cols-1 gap-4">
        <div class="flex flex-col gap-2">
          <label for="deliveryCharge" class="font-medium text-gray-900 dark:text-white">
            Monto de Descuento en Envío <span class="text-danger-500">*</span>
          </label>
          <p-inputnumber id="deliveryCharge" formControlName="deliveryCharge"
            [min]="0" suffix=" L" [showButtons]="true" [step]="5" placeholder="0" />
          @if (hasError('deliveryCharge')) {
            <small class="text-danger-500">{{ getErrorMessage('deliveryCharge') }}</small>
          }
          <small class="text-gray-500">Monto de descuento en el costo de envío</small>
        </div>
      </div>
    </p-card>
  }

  <!-- Sección: Descuento (solo si reward = 3 o 4) -->
  @if (showDiscountFields()) {
    <p-card header="Descuento">
      <div class="grid grid-cols-1 gap-4">
        <div class="flex flex-col gap-2">
          <label for="discount" class="font-medium text-gray-900 dark:text-white">
            @if (isPercentageDiscount()) {
              Porcentaje de Descuento <span class="text-danger-500">*</span>
            } @else if (isFixedDiscount()) {
              Monto de Descuento <span class="text-danger-500">*</span>
            }
          </label>
          <p-inputnumber id="discount" formControlName="discount"
            [min]="0"
            [max]="isPercentageDiscount() ? 100 : 999999"
            [suffix]="isPercentageDiscount() ? '%' : ' L'"
            [showButtons]="true"
            [step]="isPercentageDiscount() ? 1 : 10"
            placeholder="0" />
          @if (hasError('discount')) {
            <small class="text-danger-500">{{ getErrorMessage('discount') }}</small>
          }
          @if (isPercentageDiscount()) {
            <small class="text-gray-500">Porcentaje de descuento (1-100)</small>
          } @else if (isFixedDiscount()) {
            <small class="text-gray-500">Monto fijo de descuento en Lempiras</small>
          }
        </div>
      </div>
    </p-card>
  }

  <!-- Sección: Fechas y Estado -->
  <p-card header="Fechas y Estado">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Start Time -->
      <div class="flex flex-col gap-2">
        <label for="startTime" class="font-medium text-gray-900 dark:text-white">
          Fecha/Hora de Inicio <span class="text-danger-500">*</span>
        </label>
        <p-datepicker id="startTime" formControlName="startTime"
          dateFormat="dd/mm/yy" [showIcon]="true" [showTime]="true" />
        @if (hasError('startTime')) {
          <small class="text-danger-500">{{ getErrorMessage('startTime') }}</small>
        }
      </div>

      <!-- End Time -->
      <div class="flex flex-col gap-2">
        <label for="endTime" class="font-medium text-gray-900 dark:text-white">
          Fecha/Hora de Fin <span class="text-danger-500">*</span>
        </label>
        <p-datepicker id="endTime" formControlName="endTime"
          dateFormat="dd/mm/yy" [showIcon]="true" [showTime]="true" />
        @if (hasError('endTime')) {
          <small class="text-danger-500">{{ getErrorMessage('endTime') }}</small>
        }
      </div>

      <!-- Is Active -->
      <div class="flex items-center gap-3 md:col-span-2">
        <p-toggleswitch formControlName="isActive" inputId="isActive" />
        <label for="isActive" class="font-medium cursor-pointer text-gray-900 dark:text-white">
          Recompensa Activa
        </label>
      </div>
      <small class="text-gray-500 -mt-2 md:col-span-2">
        Activa o desactiva la recompensa de producto
      </small>
    </div>
  </p-card>

    <!-- Botones de Acción -->
    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
      <p-button label="Cancelar" [outlined]="true" severity="secondary"
        (onClick)="onCancel()" [disabled]="isSaving()" />
      <p-button [label]="submitButtonLabel()" icon="pi pi-check"
        (onClick)="onSubmit()" [loading]="isSaving()" [disabled]="form.invalid" />
    </div>
  </form>
}

<!-- Toast para notificaciones -->
<p-toast />
