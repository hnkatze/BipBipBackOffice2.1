<div class="p-6">
  <!-- Breadcrumb -->
  <div class="mb-4">
    <p-breadcrumb [model]="breadcrumbItems" [home]="home" />
  </div>

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
        App Links
      </h1>
      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
        Gestiona los enlaces dinámicos que redirigen a productos específicos en la app
      </p>
    </div>

    <p-button
      label="Nuevo App Link"
      icon="pi pi-plus"
      (onClick)="onCreateAppLink()"
    />
  </div>

  <!-- Filtros -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-5 mb-6">
    <div class="flex flex-col md:flex-row gap-4">
      <!-- Search -->
      <div class="flex-1">
        <p-iconfield iconPosition="left" class="w-full">
          <p-inputicon styleClass="pi pi-search" />
          <input
            type="text"
            pInputText
            placeholder="Buscar por campaña o producto..."
            class="w-full"
            [value]="searchTerm()"
            (input)="onSearch($event)"
          />
        </p-iconfield>
      </div>

      <!-- Status Filter -->
      <div class="w-full md:w-64">
        <p-select
          [options]="statusFilterOptions"
          [(ngModel)]="statusFilter"
          (onChange)="onStatusFilterChange()"
          optionLabel="label"
          optionValue="value"
          placeholder="Estado"
          class="w-full"
        />
      </div>
    </div>
  </div>

  <!-- Table (Desktop/Tablet) -->
  <div class="hidden md:block bg-white dark:bg-gray-800 rounded-lg shadow-sm">
    <p-table
        [value]="appLinks()"
        [loading]="isLoading()"
        [lazy]="true"
        [paginator]="true"
        [rows]="pageSize()"
        [totalRecords]="pagination().totalCount"
        [rowsPerPageOptions]="[5, 10, 15, 20]"
        (onLazyLoad)="onLazyLoad($event)"
        [tableStyle]="{ 'min-width': '60rem' }"
        styleClass="p-datatable-sm"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Preview</th>
            <th>Campaña</th>
            <th>Producto</th>
            <th>Marca</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th style="width: 200px">Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-appLink>
          <tr>
            <!-- Preview -->
            <td>
              <div class="flex items-center gap-3">
                <img
                  [src]="appLink.imageUrl"
                  [alt]="appLink.title"
                  class="w-16 h-16 object-cover rounded"
                />
              </div>
            </td>

            <!-- Campaign Name -->
            <td>
              <code class="bg-surface-100 dark:bg-surface-800 px-2 py-1 rounded text-sm">{{
                appLink.campaignName || 'N/A'
              }}</code>
            </td>


            <!-- Product -->
            <td>
              @if (appLink.productName) {
                <div>
                  <p class="m-0">{{ appLink.productName }}</p>
                  <p class="text-sm text-color-secondary m-0">
                    {{ appLink.productCode }}
                  </p>
                </div>
              } @else {
                <span class="text-color-secondary">-</span>
              }
            </td>

            <!-- Brand -->
            <td>
              <div class="flex items-center gap-2">
                @if (appLink.urlBrandLogo) {
                  <img
                    [src]="appLink.urlBrandLogo"
                    [alt]="appLink.brandName || ''"
                    class="w-8 h-8 object-contain"
                  />
                }
                <span>{{ appLink.brandName || 'N/A' }}</span>
              </div>
            </td>

            <!-- Status -->
            <td>
              <p-toggleswitch
                [(ngModel)]="appLink.isActive"
                (onChange)="onToggleStatus(appLink, appLink.isActive)"
              />
            </td>

            <!-- Date -->
            <td>
              <span class="text-sm">{{ formatDate(appLink.createdAt) }}</span>
            </td>

            <!-- Actions -->
            <td>
              <div class="flex gap-2">
                <p-button
                  icon="pi pi-pencil"
                  severity="secondary"
                  [text]="true"
                  [rounded]="true"
                  (onClick)="onEditAppLink(appLink)"
                  pTooltip="Editar"
                />
                <p-button
                  icon="pi pi-copy"
                  severity="info"
                  [text]="true"
                  [rounded]="true"
                  (onClick)="onCopyDeepLink(appLink)"
                  pTooltip="Copiar enlace"
                />
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center p-4">
              <p class="text-color-secondary m-0">
                @if (searchTerm()) {
                  No se encontraron app links que coincidan con "{{ searchTerm() }}"
                } @else {
                  No hay app links creados
                }
              </p>
            </td>
          </tr>
        </ng-template>
      </p-table>
  </div>

  <!-- Cards (Mobile) -->
  <div class="block md:hidden">
    @if (isLoading()) {
      <!-- Loading Skeleton -->
      <div class="flex flex-col gap-4">
        @for (item of [1, 2, 3]; track item) {
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
            <p-skeleton width="100%" height="12rem" />
          </div>
        }
      </div>
    } @else {
      <!-- Empty State -->
      @if (appLinks().length === 0) {
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-8">
          <div class="flex flex-col items-center justify-center text-gray-500 dark:text-gray-400">
            <i class="pi pi-inbox text-4xl mb-3"></i>
            <p class="text-lg font-medium">
              @if (searchTerm()) {
                No se encontraron app links que coincidan con "{{ searchTerm() }}"
              } @else {
                No hay app links creados
              }
            </p>
            @if (!searchTerm()) {
              <p-button
                label="Crear Primer App Link"
                icon="pi pi-plus"
                [outlined]="true"
                size="small"
                (onClick)="onCreateAppLink()"
                styleClass="mt-3"
              />
            }
          </div>
        </div>
      }

      <!-- Cards List -->
      @if (appLinks().length > 0) {
        <div class="flex flex-col gap-4">
          @for (appLink of appLinks(); track appLink.dynamicLinkXProductId) {
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
              <!-- Header: Imagen + Toggle -->
              <div class="flex items-start gap-3 mb-3 pb-3 border-b border-gray-200 dark:border-gray-700">
                <!-- Imagen -->
                <div class="flex-shrink-0">
                  <img
                    [src]="appLink.imageUrl"
                    [alt]="appLink.title"
                    class="w-16 h-16 object-cover rounded-lg"
                  />
                </div>

                <!-- Campaña -->
                <div class="flex-1 min-w-0">
                  <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                    Campaña
                  </label>
                  <code class="bg-surface-100 dark:bg-surface-800 px-2 py-1 rounded text-xs">
                    {{ appLink.campaignName || 'N/A' }}
                  </code>
                </div>

                <!-- Estado Toggle -->
                <div class="flex-shrink-0">
                  <p-toggleswitch
                    [(ngModel)]="appLink.isActive"
                    (onChange)="onToggleStatus(appLink, appLink.isActive)"
                  />
                </div>
              </div>

              <!-- Producto -->
              <div class="mb-3">
                <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                  Producto
                </label>
                @if (appLink.productName) {
                  <div>
                    <div class="font-medium text-sm text-gray-900 dark:text-white">{{ appLink.productName }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 font-mono mt-1">{{ appLink.productCode }}</div>
                  </div>
                } @else {
                  <span class="text-sm text-gray-500 dark:text-gray-400">-</span>
                }
              </div>

              <!-- Grid: Marca + Fecha -->
              <div class="grid grid-cols-2 gap-3 mb-3">
                <!-- Marca -->
                <div>
                  <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                    Marca
                  </label>
                  <div class="flex items-center gap-2">
                    @if (appLink.urlBrandLogo) {
                      <img
                        [src]="appLink.urlBrandLogo"
                        [alt]="appLink.brandName || ''"
                        class="w-6 h-6 object-contain"
                      />
                    }
                    <span class="text-sm">{{ appLink.brandName || 'N/A' }}</span>
                  </div>
                </div>

                <!-- Fecha -->
                <div>
                  <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                    Fecha
                  </label>
                  <span class="text-sm text-gray-900 dark:text-white">{{ formatDate(appLink.createdAt) }}</span>
                </div>
              </div>

              <!-- Acciones -->
              <div class="flex items-center gap-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                <p-button
                  label="Editar"
                  icon="pi pi-pencil"
                  size="small"
                  [outlined]="true"
                  severity="secondary"
                  (onClick)="onEditAppLink(appLink)"
                  styleClass="flex-1"
                />
                <p-button
                  label="Copiar Link"
                  icon="pi pi-copy"
                  size="small"
                  [outlined]="true"
                  severity="info"
                  (onClick)="onCopyDeepLink(appLink)"
                  styleClass="flex-1"
                />
              </div>
            </div>
          }
        </div>

        <!-- Paginador Mobile -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mt-4">
          <p-paginator
            [rows]="pageSize()"
            [totalRecords]="pagination().totalCount"
            [rowsPerPageOptions]="[5, 10, 15, 20]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
            (onPageChange)="onPageChange($event)"
          />
        </div>
      }
    }
  </div>
</div>

<p-toast />
<p-confirmDialog />

<!-- Full-Screen Drawer with Form -->
<p-drawer
  [(visible)]="drawerVisible"
  position="full"
  [modal]="true"
>
  <ng-template pTemplate="header">
    <h2 class="text-2xl font-bold m-0">
      {{ selectedAppLink() ? 'Editar App Link' : 'Nuevo App Link' }}
    </h2>
  </ng-template>

  <app-app-link-form
    [appLink]="selectedAppLink()"
    (save)="onFormSave()"
    (cancel)="onDrawerClose()"
  />
</p-drawer>
