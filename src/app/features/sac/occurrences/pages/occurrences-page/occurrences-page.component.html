<!-- Toast notifications -->
<p-toast />

<!-- Confirm dialog -->
<p-confirmDialog />

<!-- Breadcrumb -->
<p-breadcrumb
  [model]="breadcrumbItems"
  [home]="home"
  class="mb-4"
/>

<!-- Page header -->
<div class="flex justify-between items-center mb-6">
  <div>
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestión de Ocurrencias</h1>
    <p class="text-gray-600">Administra las incidencias reportadas en el sistema</p>
  </div>
  <div class="flex gap-2">
    <p-button
      label="Reporte"
      icon="pi pi-file-excel"
      [outlined]="true"
      routerLink="reports"
    />
  </div>
</div>

<!-- Search and filters -->
<div class=" rounded-lg shadow-sm p-4 mb-4">
  <div class="flex gap-4 items-center">
    <div class="flex-1">
      <p-iconfield iconPosition="left">
        <p-inputicon styleClass="pi pi-search" />
        <input
          pInputText
          type="text"
          placeholder="Buscar por número de orden..."
          [(ngModel)]="searchTerm"
          class="w-full"
        />
      </p-iconfield>
    </div>
    <p-button
      label="Limpiar"
      icon="pi pi-times"
      [outlined]="true"
      severity="secondary"
      (onClick)="searchTerm.set('')"
      [disabled]="!searchTerm()"
    />
  </div>
</div>

<!-- Table (Desktop/Tablet) -->
<div class="hidden md:block rounded-lg shadow-sm">
  @if (isLoading()) {
    <!-- Loading skeleton -->
    <div class="p-4">
      @for (item of [1,2,3,4,5]; track item) {
        <div class="flex gap-4 mb-4">
          <p-skeleton width="100%" height="3rem" />
        </div>
      }
    </div>
  } @else {
    <p-table
      [value]="filteredOccurrences()"
      [paginator]="true"
      [rows]="rowsPerPage()"
      [rowsPerPageOptions]="rowsPerPageOptions"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} ocurrencias"
      [tableStyle]="{ 'min-width': '60rem' }"
      styleClass="p-datatable-sm"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="type">
            Tipo / Razón
            <p-sortIcon field="type" />
          </th>
          <th pSortableColumn="orderId">
            Orden #
            <p-sortIcon field="orderId" />
          </th>
          <th pSortableColumn="posgc">
            POSGC
            <p-sortIcon field="posgc" />
          </th>
          <th pSortableColumn="channel">
            Canal
            <p-sortIcon field="channel" />
          </th>
          <th pSortableColumn="store">
            Unidad
            <p-sortIcon field="store" />
          </th>
          <th pSortableColumn="createdAt">
            Fecha
            <p-sortIcon field="createdAt" />
          </th>
          <th pSortableColumn="createdBy">
            Usuario Solicitante
            <p-sortIcon field="createdBy" />
          </th>
          <th>Solución</th>
          <th>Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-occurrence>
        <tr>
          <!-- Tipo / Razón -->
          <td>
            <div class="flex flex-col gap-1">
              <span class="font-semibold text-sm">{{ occurrence.type }}</span>
              <span class="text-xs text-gray-600">{{ occurrence.reason }}</span>
            </div>
          </td>

          <!-- Orden # -->
          <td>
            <span class="font-mono text-primary cursor-pointer hover:underline" (click)="viewOrder(occurrence.orderId)">
              {{ occurrence.orderId }}
            </span>
          </td>

          <!-- POSGC -->
          <td>
            <span class="font-mono text-sm">{{ occurrence.posgc }}</span>
          </td>

          <!-- Canal -->
          <td>{{ occurrence.channel }}</td>

          <!-- Unidad -->
          <td>{{ occurrence.store }}</td>

          <!-- Fecha -->
          <td>
            <span class="text-sm">{{ formatDate(occurrence.createdAt) }}</span>
          </td>

          <!-- Usuario Solicitante -->
          <td>{{ occurrence.createdBy }}</td>

          <!-- Solución -->
          <td>
            <p-button
              [text]="true"
              icon="pi pi-eye"
              severity="info"
              size="small"
              (onClick)="viewSolution(occurrence)"
              [disabled]="!occurrence.solution || occurrence.solution.length === 0"
            />
          </td>

          <!-- Acciones -->
          <td class="text-center">
            <p-button
              icon="pi pi-ellipsis-v"
              [text]="true"
              [rounded]="true"
              severity="secondary"
              size="small"
              (onClick)="actionsMenu.toggle($event)"
            />
            <p-popover #actionsMenu>
              <div class="flex flex-col gap-1 p-2">
                <button
                  class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors"
                  (click)="viewOrder(occurrence.orderId); actionsMenu.hide()"
                >
                  <i class="pi pi-eye text-blue-600"></i>
                  <span>Ver Orden</span>
                </button>
                <button
                  class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors"
                  (click)="editOccurrence(occurrence); actionsMenu.hide()"
                >
                  <i class="pi pi-pencil text-yellow-600"></i>
                  <span>Editar</span>
                </button>
                <button
                  class="flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors"
                  (click)="deleteOccurrence(occurrence); actionsMenu.hide()"
                >
                  <i class="pi pi-trash text-red-600"></i>
                  <span>Eliminar</span>
                </button>
              </div>
            </p-popover>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center py-8">
            <div class="flex flex-col items-center gap-3">
              <i class="pi pi-inbox text-4xl text-gray-400"></i>
              <p class="text-gray-600">
                @if (searchTerm()) {
                  No se encontraron ocurrencias con el criterio de búsqueda
                } @else {
                  No hay ocurrencias registradas
                }
              </p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
</div>

<!-- Cards (Mobile) -->
<div class="block md:hidden">
  @if (isLoading()) {
    <!-- Loading skeleton -->
    <div class="flex flex-col gap-4">
      @for (item of [1,2,3]; track item) {
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
          <p-skeleton width="100%" height="8rem" />
        </div>
      }
    </div>
  } @else {
    <!-- Empty State -->
    @if (filteredOccurrences().length === 0) {
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-8">
        <div class="flex flex-col items-center justify-center text-gray-500 dark:text-gray-400">
          <i class="pi pi-inbox text-4xl mb-3"></i>
          <p class="text-lg font-medium">
            @if (searchTerm()) {
              No se encontraron ocurrencias
            } @else {
              No hay ocurrencias registradas
            }
          </p>
        </div>
      </div>
    }

    <!-- Cards List -->
    @if (filteredOccurrences().length > 0) {
      <div class="flex flex-col gap-4">
        @for (occurrence of filteredOccurrences(); track occurrence.id) {
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
            <!-- Tipo y Razón -->
            <div class="mb-3 pb-3 border-b border-gray-200 dark:border-gray-700">
              <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                Tipo / Razón
              </label>
              <div class="flex flex-col gap-1">
                <span class="font-semibold text-sm">{{ occurrence.type }}</span>
                <span class="text-xs text-gray-600 dark:text-gray-400">{{ occurrence.reason }}</span>
              </div>
            </div>

            <!-- Grid de info principal -->
            <div class="grid grid-cols-2 gap-3 mb-3">
              <!-- Orden -->
              <div>
                <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                  Orden #
                </label>
                <span class="font-mono text-primary text-sm cursor-pointer hover:underline" (click)="viewOrder(occurrence.orderId)">
                  {{ occurrence.orderId }}
                </span>
              </div>

              <!-- POSGC -->
              <div>
                <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                  POSGC
                </label>
                <span class="font-mono text-sm">{{ occurrence.posgc }}</span>
              </div>

              <!-- Canal -->
              <div>
                <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                  Canal
                </label>
                <span class="text-sm">{{ occurrence.channel }}</span>
              </div>

              <!-- Unidad -->
              <div>
                <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                  Unidad
                </label>
                <span class="text-sm">{{ occurrence.store }}</span>
              </div>
            </div>

            <!-- Fecha y Usuario -->
            <div class="mb-3">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                    Fecha
                  </label>
                  <span class="text-sm">{{ formatDate(occurrence.createdAt) }}</span>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 block">
                    Usuario
                  </label>
                  <span class="text-sm">{{ occurrence.createdBy }}</span>
                </div>
              </div>
            </div>

            <!-- Acciones -->
            <div class="flex items-center gap-2 pt-3 border-t border-gray-200 dark:border-gray-700">
              <p-button
                label="Ver Solución"
                icon="pi pi-eye"
                size="small"
                [outlined]="true"
                severity="info"
                (onClick)="viewSolution(occurrence)"
                [disabled]="!occurrence.solution || occurrence.solution.length === 0"
                styleClass="flex-1"
              />
              <p-button
                icon="pi pi-ellipsis-v"
                [text]="true"
                [rounded]="true"
                severity="secondary"
                size="small"
                (onClick)="actionsMenu.toggle($event)"
              />
              <p-popover #actionsMenu>
                <div class="flex flex-col gap-1 p-2 min-w-[160px]">
                  <button
                    class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors w-full text-left"
                    (click)="viewOrder(occurrence.orderId); actionsMenu.hide()"
                  >
                    <i class="pi pi-eye text-blue-600"></i>
                    <span>Ver Orden</span>
                  </button>
                  <button
                    class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors w-full text-left"
                    (click)="editOccurrence(occurrence); actionsMenu.hide()"
                  >
                    <i class="pi pi-pencil text-yellow-600"></i>
                    <span>Editar</span>
                  </button>
                  <button
                    class="flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors w-full text-left"
                    (click)="deleteOccurrence(occurrence); actionsMenu.hide()"
                  >
                    <i class="pi pi-trash text-red-600"></i>
                    <span>Eliminar</span>
                  </button>
                </div>
              </p-popover>
            </div>
          </div>
        }
      </div>

      <!-- Paginador Mobile -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mt-4">
        <p-paginator
          [rows]="rowsPerPage()"
          [totalRecords]="filteredOccurrences().length"
          [rowsPerPageOptions]="rowsPerPageOptions"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
        />
      </div>
    }
  }
</div>

<!-- Solution View Dialog -->
<app-solution-dialog
  [visible]="showSolutionDialog()"
  [solutions]="selectedSolution()"
  (onClose)="showSolutionDialog.set(false)"
/>

<!-- Edit Occurrence Dialog -->
<app-edit-occurrence-dialog
  [visible]="showEditDialog()"
  [occurrenceId]="selectedOccurrenceId()"
  (onClose)="showEditDialog.set(false)"
  (onSave)="onSolutionSaved()"
/>
