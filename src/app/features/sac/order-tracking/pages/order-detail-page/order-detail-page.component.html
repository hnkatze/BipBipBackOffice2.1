<p-toast />

<div class="p-4 max-w-7xl mx-auto">
  <!-- Breadcrumb -->
  <p-breadcrumb [model]="breadcrumbItems()" [home]="home" styleClass="mb-4" />

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="flex items-center justify-center py-12">
      <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
      <span class="ml-3 text-lg ">Cargando detalle...</span>
    </div>
  }

  <!-- Order Not Found -->
  @else if (notFound()) {
    <div class="border border-yellow-200 bg-yellow-50 rounded-lg p-6 text-center">
      <i class="pi pi-exclamation-triangle text-4xl text-yellow-600 mb-3"></i>
      <h2 class="text-xl font-bold  mb-2">Orden no encontrada</h2>
      <p class=" mb-4">
        No se pudo encontrar la orden solicitada. Es posible que no exista o no tengas permisos para verla.
      </p>
      <p-button
        label="Volver a la lista"
        icon="pi pi-arrow-left"
        (onClick)="goBack()"
      />
    </div>
  }

  <!-- Order Detail Content -->
  @else if (orderDetail(); as order) {
    <div class="space-y-4">
      <!-- Page Header with Back Button -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-3">
          <p-button
            icon="pi pi-arrow-left"
            [text]="true"
            [rounded]="true"
            size="large"
            (onClick)="goBack()"
            severity="secondary"
          />
          <div>
            <h1 class="text-2xl font-bold ">
              Orden #{{ order.numOrder }}
            </h1>
            <div class="flex items-center gap-2 mt-1">
              <p-badge
                [value]="order.orderStatus"
                [severity]="statusSeverity()"
              />
              @if (isExpressOrder()) {
                <div class="express-tag">
                  <i class="pi pi-bolt"></i>
                  <span>EXPRESS</span>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Reload Button -->
        <p-button
          icon="pi pi-refresh"
          label="Actualizar"
          [outlined]="true"
          (onClick)="reload()"
          [loading]="isLoading()"
        />
      </div>

      <!-- Tabs -->
      <p-tabs [value]="activeTabIndex()">
        <p-tablist>
          <p-tab [value]="0">Detalle</p-tab>
          <p-tab [value]="1">Solicitudes de Cancelación</p-tab>
          <p-tab [value]="2">Ocurrencias</p-tab>
          <p-tab [value]="3">Incidencias</p-tab>
        </p-tablist>

        <p-tabpanels>
          <!-- TAB 1: DETALLE -->
          <p-tabpanel [value]="0">
          <div class="py-4 space-y-4">

            <!-- Section 1: Header with POSGC and Actions -->
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <!-- POSGC Info -->
                <div class="flex items-center gap-3">
                  @if (order.posgc) {
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-semibold ">POSGC:</span>
                      <span class="text-base font-bold ">{{ order.posgc }}</span>
                      <button
                        type="button"
                        class="text-primary hover:text-primary-dark"
                        (click)="downloadInvoice()"
                        title="Descargar factura"
                      >
                        <i class="pi pi-download text-sm"></i>
                      </button>
                    </div>
                  } @else {
                    <span class="text-sm ">Sin POSGC</span>
                  }
                </div>

                <!-- Action Buttons - Desktop -->
                <div class="hidden sm:flex items-center gap-2">
                  @if (canShowSendButton()) {
                    <p-button
                      label="Enviar pedido"
                      icon="pi pi-send"
                      size="small"
                      [outlined]="true"
                      (onClick)="onSendOrderClick()"
                    />
                  }
                  @if (canShowCompleteButton()) {
                    <p-button
                      label="Completar"
                      icon="pi pi-check"
                      severity="success"
                      size="small"
                      [outlined]="true"
                      (onClick)="onCompleteOrderClick()"
                    />
                  }
                  @if (canShowCancelButton()) {
                    <p-button
                      label="Cancelar"
                      icon="pi pi-ban"
                      severity="danger"
                      size="small"
                      [outlined]="true"
                      (onClick)="onCancelOrderClick()"
                    />
                  }
                  <p-button
                    label="Chat"
                    icon="pi pi-comments"
                    severity="secondary"
                    size="small"
                    [outlined]="true"
                    (onClick)="onChatClick()"
                  />
                  <p-button
                    label="Crear incidencia"
                    icon="pi pi-exclamation-circle"
                    severity="secondary"
                    size="small"
                    [outlined]="true"
                    (onClick)="onCreateIncidentClick()"
                  />
                </div>

                <!-- Action Buttons - Mobile (Menu) -->
                <div class="flex sm:hidden">
                  <p-button
                    icon="pi pi-ellipsis-v"
                    [text]="true"
                    [rounded]="true"
                  />
                </div>
              </div>
            </div>


            <!-- Section 2: General Data (2 columns) -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h2 class="text-lg font-semibold  mb-4">Datos generales</h2>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 divide-y md:divide-y-0 md:divide-x divide-gray-200">
                <!-- Left Column -->
                <div class="space-y-4 md:pr-6">
                  <!-- Customer -->
                  <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full  text-white flex items-center justify-center font-semibold text-lg">
                      {{ order.customerName.charAt(0).toUpperCase() }}
                    </div>
                    <div class="flex-1">
                      <div class="flex items-center justify-between mb-1">
                        <label class="text-xs font-semibold  uppercase">Cliente</label>
                        @if (order.customerPenalized) {
                          <p-badge value="Penalizado" severity="danger" styleClass="text-xs" />
                        }
                      </div>
                      <p class="text-base font-medium ">{{ order.customerName }}</p>
                      <div class="flex items-center gap-1 text-sm ">
                        <i class="pi pi-phone text-xs"></i>
                        <span>{{ order.phoneCustomer }}</span>
                      </div>
                      @if (order.customerSecondaryPhone) {
                        <div class="flex items-center gap-1 text-sm text-gray-600">
                          <i class="pi pi-phone text-xs"></i>
                          <span>{{ order.customerSecondaryPhone }} (Secundario)</span>
                        </div>
                      }
                      <!-- Penalize Customer Button -->
                      @if (!order.customerPenalized) {
                        <div class="mt-2">
                          <p-button
                            label="Penalizar Cliente"
                            icon="pi pi-exclamation-triangle"
                            severity="danger"
                            size="small"
                            [outlined]="true"
                            (onClick)="onPenalizeCustomerClick()"
                          />
                        </div>
                      }
                    </div>
                  </div>

                  <!-- Driver -->
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Repartidor</label>
                    @if (order.nameDriver) {
                      <div class="flex items-center gap-2">
                        <p class="text-base font-medium ">{{ order.nameDriver }}</p>
                        <button class="text-primary hover:text-primary-dark">
                          <i class="pi pi-info-circle text-sm"></i>
                        </button>
                      </div>
                      <!-- TODO: Add driver assignment component -->
                    } @else {
                      <p class=" italic">No asignado</p>
                    }
                  </div>

                  <!-- Distance -->
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Distancia</label>
                    <p class="text-base ">{{ order.distanceOrder }} km</p>
                  </div>

                  <!-- Date & Time -->
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Fecha y hora</label>
                    <p class="text-base ">{{ order.orderDate | date:'medium' }}</p>
                  </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-4 pt-4 md:pt-0 md:pl-6">
                  <!-- Store/Brand -->
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Tienda / Marca</label>
                    <div class="flex items-center justify-between gap-3">
                      <div class="flex items-center gap-3">
                        @if (order.brandLogo) {
                          <img [src]="order.brandLogo" [alt]="order.storeShortName" class="w-12 h-12 rounded object-contain border border-gray-200" />
                        }
                        <p class="text-base font-medium ">{{ order.storeShortName }}</p>
                      </div>
                      <!-- Change Store Button -->
                      <p-button
                        label="Cambiar"
                        icon="pi pi-building"
                        severity="secondary"
                        size="small"
                        [outlined]="true"
                        (onClick)="onChangeStoreClick()"
                      />
                    </div>
                  </div>

                  <!-- Payment Method -->
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Método de pago</label>
                    <p class="text-base ">{{ order.namePaymentMethod }}</p>
                  </div>

                  <!-- Channel -->
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Canal de pedido</label>
                    <p class="text-base ">
                      {{ order.channelId === 3 ? 'CALL CENTER' : (order.channelId === 1 ? 'DELIVERY' : 'PICKUP') }}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Comments / Instructions -->
              @if (order.comments || order.instructionsForDelivery) {
                <div class="mt-4 space-y-3">
                  @if (order.comments) {
                    <div class="border-l-4 border-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                      <div class="flex items-start gap-2">
                        <i class="pi pi-info-circle text-yellow-600 dark:text-yellow-400 mt-0.5"></i>
                        <div>
                          <p class="text-xs font-bold text-yellow-800 dark:text-yellow-300 uppercase mb-1">Comentarios para Restaurante</p>
                          <p class="text-sm text-yellow-900 dark:text-yellow-100 font-medium">{{ order.comments }}</p>
                        </div>
                      </div>
                    </div>
                  }
                  @if (order.instructionsForDelivery) {
                    <div class="border-l-4 border-blue-400 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                      <div class="flex items-start gap-2">
                        <i class="pi pi-directions text-blue-600 dark:text-blue-400 mt-0.5"></i>
                        <div>
                          <p class="text-xs font-bold text-blue-800 dark:text-blue-300 uppercase mb-1">Instrucciones para Driver</p>
                          <p class="text-sm text-blue-900 dark:text-blue-100 font-medium">{{ order.instructionsForDelivery }}</p>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>

            <!-- Section 3: Delivery Time (Conditional - only for delivery) -->
            @if (order.channelId === 1) {
              <div class="border border-gray-200 rounded-lg p-4">
                <h2 class="text-lg font-semibold  mb-4">Tiempos de entrega</h2>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Tiempo estimado</label>
                    <p class="text-base font-medium ">
                      {{ order.estimatedTime || 'N/A' }}
                    </p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Hora inicio</label>
                    <p class="text-base font-medium ">
                      @if (order.status && order.status.length > 0 && order.status[0].time) {
                        {{ order.status[0].time }}
                      } @else {
                        N/A
                      }
                    </p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Tiempo real</label>
                    <p class="text-base font-medium ">
                      {{ order.realTime || 'N/A' }}
                    </p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold  uppercase block mb-1">Hora fin</label>
                    <p class="text-base font-medium ">
                      @if (order.deliveryDate) {
                        {{ order.deliveryDate | date:'shortTime' }}
                      } @else {
                        Pendiente
                      }
                    </p>
                  </div>
                </div>
              </div>
            }

            <!-- Driver Assignment Component -->
            <app-driver-assignment
              [orderDetail]="order"
              [isLoading]="false"
              (assignDriver)="onAssignDriver()"
              (reassignDriver)="onReassignDriver()"
              (releaseDriver)="onReleaseDriver()"
              (viewDriverDetails)="onViewDriverDetails($event)"
              (penalizeDriver)="onPenalizeDriver($event)"
            />

            <!-- Section 4: Products & Invoice -->
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="mb-4 pb-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold ">Factura de venta</h2>
              </div>

              <!-- Company & Customer Info -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6 pb-6 border-b border-gray-200">
                <!-- Company Info -->
                <div>
                  @if (order.rtn) {
                    <p class="text-sm font-semibold ">{{ order.rtn.businessName }}</p>
                    <p class="text-sm ">RTN: {{ order.rtn.rtnNumber }}</p>
                  }
                </div>

                <!-- Customer Info -->
                <div>
                  <p class="text-sm font-semibold ">{{ order.customerName }}</p>
                  <p class="text-sm ">{{ order.phoneCustomer }}</p>
                  @if (order.channelId === 1 || order.channelId === 3) {
                    <p class="text-sm ">{{ order.addressCustomer }}</p>
                    @if (order.referencePoints) {
                      <p class="text-sm  italic">Ref: {{ order.referencePoints }}</p>
                    }
                  }
                </div>
              </div>

              <!-- Products Table - Desktop -->
              <div class="hidden sm:block overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class=" border-y border-gray-200">
                    <tr>
                      <th class="text-left p-3 font-semibold ">CONCEPTO</th>
                      <th class="text-right p-3 font-semibold ">PRECIO</th>
                      <th class="text-center p-3 font-semibold ">CANT</th>
                      <th class="text-right p-3 font-semibold ">SUBTOTAL</th>
                      <th class="text-center p-3 font-semibold ">ISV</th>
                      <th class="text-right p-3 font-semibold ">TOTAL</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (product of order.ordersProductsDetails; track product.idProduct) {
                      <tr class="border-b border-gray-100">
                        <td class="p-3">
                          <p class="font-medium ">{{ product.productName }}</p>
                          @if (product.modifiers) {
                            <p class="text-xs ">{{ product.modifiers }}</p>
                          }
                          @if (product.comments) {
                            <p class="text-xs text-red-600 font-medium italic">{{ product.comments }}</p>
                          }
                        </td>
                        <td class="p-3 text-right">L. {{ (product.unitPrice || 0).toFixed(2) }}</td>
                        <td class="p-3 text-center">{{ product.quantity }}</td>
                        <td class="p-3 text-right">L. {{ (product.subtotal || 0).toFixed(2) }}</td>
                        <td class="p-3 text-center">{{ product.taxPercentage || 0 }}%</td>
                        <td class="p-3 text-right font-semibold">L. {{ (product.total || 0).toFixed(2) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>

              <!-- Products Cards - Mobile -->
              <div class="flex sm:hidden flex-col gap-3 mb-4">
                @for (product of order.ordersProductsDetails; track product.idProduct) {
                  <div class="border border-gray-200 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-2">
                      <div class="flex-1">
                        <p class="font-medium ">{{ product.productName }}</p>
                        @if (product.modifiers) {
                          <p class="text-xs  mt-1">{{ product.modifiers }}</p>
                        }
                        @if (product.comments) {
                          <p class="text-xs text-red-600 font-medium italic mt-1">{{ product.comments }}</p>
                        }
                      </div>
                      <p class="font-semibold  ml-2">L. {{ (product.total || 0).toFixed(2) }}</p>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-xs ">
                      <div>
                        <span class="font-medium">Cant:</span> {{ product.quantity }}
                      </div>
                      <div>
                        <span class="font-medium">Precio:</span> L. {{ (product.unitPrice || 0).toFixed(2) }}
                      </div>
                      <div>
                        <span class="font-medium">ISV:</span> {{ product.taxPercentage }}%
                      </div>
                    </div>
                  </div>
                }
              </div>

              <!-- Payment Details -->
              @if (order.paidDetails && order.paidDetails.length > 0) {
                <div class="mt-6 pt-6 border-t border-gray-200">
                  <div class="space-y-2 max-w-md ml-auto">
                    @for (detail of order.paidDetails; track detail.name) {
                      <div class="flex justify-between text-sm">
                        <span class="">{{ detail.name }}</span>
                        <span class="font-medium ">L. {{ (detail.amount || 0).toFixed(2) }}</span>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Payment Gateway Info -->
              @if (order.responseCard || order.authorizationCode || order.cardUsed) {
                <div class="mt-4 pt-4 border-t border-gray-200">
                  <h3 class="text-sm font-bold text-gray-800 uppercase mb-3">Información de Pago</h3>
                  <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-2">
                    @if (order.cardUsed) {
                      <div class="flex items-center gap-2">
                        <i class="pi pi-credit-card text-gray-600"></i>
                        <span class="text-sm font-medium text-gray-700">Tarjeta:</span>
                        <span class="text-sm text-gray-900 font-semibold">{{ order.cardUsed }}</span>
                      </div>
                    }
                    @if (order.authorizationCode) {
                      <div class="flex items-center gap-2">
                        <i class="pi pi-check-circle text-green-600"></i>
                        <span class="text-sm font-medium text-gray-700">Código de Autorización:</span>
                        <span class="text-sm text-gray-900 font-mono">{{ order.authorizationCode }}</span>
                      </div>
                    }
                    @if (order.responseCard) {
                      <div class="flex items-center gap-2">
                        <i class="pi pi-info-circle text-blue-600"></i>
                        <span class="text-sm font-medium text-gray-700">Respuesta del Gateway:</span>
                        <span class="text-sm text-gray-900">{{ order.responseCard }}</span>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Split Payment Section -->
              @if (order.splitPayment && order.splitPayment.length > 0) {
                <div class="mt-4 pt-4 border-t border-gray-200">
                  <h3 class="text-sm font-bold text-gray-800 uppercase mb-3 flex items-center gap-2">
                    <i class="pi pi-users"></i>
                    Pago Dividido ({{ order.splitPayment.length }} participantes)
                  </h3>
                  <div class="space-y-3">
                    @for (split of order.splitPayment; track split.idSplit) {
                      <div class="border rounded-lg p-4"
                           [class.border-green-300]="split.isPaid"
                           [class.bg-green-50]="split.isPaid"
                           [class.border-gray-200]="!split.isPaid"
                           [class.bg-gray-50]="!split.isPaid">
                        <div class="flex justify-between items-start mb-3">
                          <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                              <i class="pi pi-user text-sm text-gray-600"></i>
                              <span class="font-semibold text-gray-900">{{ split.customerName }}</span>
                              @if (split.isPaid) {
                                <p-badge value="Pagado" severity="success" styleClass="text-xs" />
                              } @else {
                                <p-badge value="Pendiente" severity="warn" styleClass="text-xs" />
                              }
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                              <i class="pi pi-phone text-xs"></i>
                              <span>{{ split.customerPhone }}</span>
                            </div>
                          </div>
                          <div class="text-right">
                            <p class="text-xs text-gray-600 uppercase font-medium">{{ split.type }}</p>
                            <p class="text-lg font-bold text-gray-900">L. {{ split.amount.toFixed(2) }}</p>
                          </div>
                        </div>

                        <!-- Products assigned to this split -->
                        @if (split.products && split.products.length > 0) {
                          <div class="border-t border-gray-200 pt-3 mt-3">
                            <p class="text-xs font-semibold text-gray-700 uppercase mb-2">Productos asignados:</p>
                            <div class="space-y-2">
                              @for (product of split.products; track product.idProduct) {
                                <div class="flex items-center gap-2 text-sm">
                                  <span class="font-medium text-gray-600">{{ product.quantity }}x</span>
                                  <span class="text-gray-900">{{ product.productName }}</span>
                                  <span class="ml-auto font-medium text-gray-700">L. {{ product.price.toFixed(2) }}</span>
                                </div>
                              }
                            </div>
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            </div>

            <!-- Section 5: Order History Timeline -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h2 class="text-lg font-semibold  mb-4">Historial de la orden</h2>
              <div class="space-y-3">
                @for (status of order.status; track status.name) {
                  <div class="flex items-start gap-3">
                    <div class="w-2 h-2  rounded-full mt-2 flex-shrink-0"></div>
                    <div class="flex-1 min-w-0">
                      <p class="text-sm ">
                        <span class="font-medium">{{ status.time }}</span>
                        @if (status.driver) {
                          <span class=""> | Driver: {{ status.driver }}</span>
                        }
                        <span class=""> | Estado: </span>
                        <span class="font-medium">{{ status.name }}</span>
                      </p>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Section 6: Location & Map -->
            <div class="border border-gray-200 rounded-lg p-4">
              <h2 class="text-lg font-semibold  mb-4">Mapa de ubicación</h2>
              @if (mapMarkers().length > 0 && mapRoute()) {
                <div style="height: 400px;">
                  <app-google-map
                    [markers]="mapMarkers()"
                    [route]="mapRoute()"
                  />
                </div>
              } @else {
                <div class="bg-gray-100 rounded-lg p-8 text-center">
                  <i class="pi pi-map-marker text-4xl mb-2"></i>
                  <p class="">No hay coordenadas disponibles</p>
                  <p class="text-sm  mt-1">{{ order.addressCompany }}</p>
                </div>
              }
            </div>

          </div>
        </p-tabpanel>

          <!-- TAB 2: SOLICITUDES DE CANCELACIÓN -->
          <p-tabpanel [value]="1">
            <app-cancellation-requests-table
              [cancelRequests]="order.cancelRequest || []"
              (approveRequest)="onApproveRequest($event)"
              (denyRequest)="onDenyRequest($event)"
            />
          </p-tabpanel>

          <!-- TAB 3: OCURRENCIAS (Manual Incidents) -->
          <p-tabpanel [value]="2">
            <app-occurrences-list [incidents]="order.incidents || []" />
          </p-tabpanel>

          <!-- TAB 4: INCIDENCIAS (System Audit) -->
          <p-tabpanel [value]="3">
            <app-incidents-table [orderId]="orderId()!" />
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </div>
  }
</div>

<!-- Dialogs -->
@if (orderDetail(); as order) {
  <!-- Complete Order Dialog -->
  <app-complete-order-dialog
    [visible]="showCompleteDialog()"
    [orderNumber]="order.numOrder"
    [customerName]="order.customerName"
    [loading]="completeLoading()"
    (visibleChange)="showCompleteDialog.set($event)"
    (confirm)="onConfirmComplete()"
  />

  <!-- Send Order Dialog -->
  <app-send-order-dialog
    [visible]="showSendDialog()"
    [orderNumber]="order.numOrder"
    [customerName]="order.customerName"
    [scheduledTime]="order.orderDate | date:'medium'"
    [loading]="sendLoading()"
    (visibleChange)="showSendDialog.set($event)"
    (confirm)="onConfirmSend()"
  />

  <!-- Create Incident Dialog -->
  <app-create-incident-dialog
    [visible]="showIncidentDialog()"
    [orderNumber]="order.numOrder"
    [loading]="incidentLoading()"
    (visibleChange)="showIncidentDialog.set($event)"
    (confirm)="onConfirmIncident($event)"
  />

  <!-- Approve Cancellation Dialog -->
  @if (selectedCancelRequest(); as request) {
    <app-approve-cancellation-dialog
      [visible]="showApproveCancellationDialog()"
      [request]="request"
      [loading]="approveCancellationLoading()"
      (visibleChange)="showApproveCancellationDialog.set($event)"
      (confirm)="onConfirmApprove()"
    />
  }

  <!-- Deny Cancellation Dialog -->
  @if (selectedCancelRequest(); as request) {
    <app-deny-cancellation-dialog
      [visible]="showDenyCancellationDialog()"
      [request]="request"
      [loading]="denyCancellationLoading()"
      (visibleChange)="showDenyCancellationDialog.set($event)"
      (confirm)="onConfirmDeny()"
    />
  }

  <!-- Penalize Customer Dialog -->
  <app-penalize-customer-dialog
    [visible]="showPenalizeCustomerDialog()"
    [customerId]="order.idCustomer"
    [customerName]="order.customerName"
    [loading]="penalizeCustomerLoading()"
    (visibleChange)="showPenalizeCustomerDialog.set($event)"
    (confirm)="onConfirmPenalizeCustomer()"
  />

  <!-- Change Store Dialog -->
  <app-change-store-dialog
    [visible]="showChangeStoreDialog()"
    [orderId]="order.numOrder"
    [currentStoreId]="order.idCompany"
    [currentStoreName]="order.storeShortName"
    [loading]="changeStoreLoading()"
    (visibleChange)="showChangeStoreDialog.set($event)"
    (confirm)="onConfirmChangeStore()"
  />
}
