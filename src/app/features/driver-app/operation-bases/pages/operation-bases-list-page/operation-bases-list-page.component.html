<div class="operation-bases-list-page p-4">
  <!-- Breadcrumb -->
  <app-breadcrumb [items]="breadcrumbItems()" />

  <!-- Header -->
  <div class="flex flex-wrap justify-between items-start gap-3 mb-6">
    <div>
      <h1 class="text-2xl font-bold m-0 mb-2">Bases de Operaciones</h1>
      <p class="text-sm text-gray-600 dark:text-gray-400 m-0">
        Gestiona las bases de operaciones, visualiza su ubicación en el mapa y administra los drivers asignados a cada base.
      </p>
    </div>

    <div class="flex gap-2">
      <p-button
        icon="pi pi-plus"
        label="Crear Base"
        (onClick)="createBase()"
      />
      <p-button
        icon="pi pi-filter"
        label="Filtros"
        [text]="true"
        severity="secondary"
        (onClick)="openFilters()"
      />
    </div>
  </div>

  <!-- Tabs Container -->
  <div class="border border-gray-300 dark:border-gray-700 rounded-lg bg-surface-card overflow-hidden">
    <p-tabs [value]="activeTabIndex().toString()" (onChange)="onTabChange($event)">
      <p-tablist>
        <p-tab value="0">Mapa</p-tab>
        <p-tab value="1">Lista</p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- TAB PANEL 1: MAPA -->
        <p-tabpanel value="0">
          @if (loading()) {
            <div class="p-4">
              <p-skeleton height="500px" />
            </div>
          } @else {
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-4">
              <!-- Panel Lateral con Lista de Bases -->
              <div class="lg:col-span-1 order-2 lg:order-1">
                <!-- Search para filtrar el panel -->
                <div class="mb-2">
                  <p-iconfield iconPosition="left" class="w-full">
                    <p-inputicon class="pi pi-search" />
                    <input
                      pInputText
                      type="text"
                      placeholder="Filtrar..."
                      class="w-full text-sm"
                      [ngModel]="sidebarSearchTerm()"
                      (ngModelChange)="sidebarSearchTerm.set($event)"
                    />
                  </p-iconfield>
                </div>

                <div class="max-h-[460px] overflow-y-auto space-y-2">
                  @if (filteredOperationBases().length === 0) {
                    <p-card>
                      <div class="text-center py-6">
                        <i class="pi pi-inbox text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-500 dark:text-gray-400 m-0">
                          No se encontraron bases
                        </p>
                      </div>
                    </p-card>
                  } @else {
                    @for (base of filteredOperationBases(); track trackByHeadquarterId($index, base)) {
                      <p-card
                        class="cursor-pointer hover:shadow-lg transition-shadow"
                        (click)="focusOnBase(base)"
                      >
                        <div class="flex items-start gap-2">
                          <!-- Logo -->
                          <img
                            [src]="base.pathLogoHeadquarter"
                            [alt]="base.headquarterName"
                            class="w-10 h-10 rounded object-cover flex-shrink-0"
                          />

                          <!-- Info -->
                          <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-sm m-0 mb-0.5 truncate">
                              {{ base.headquarterName }}
                            </h3>
                            <p class="text-xs text-gray-600 dark:text-gray-400 m-0 mb-1.5 line-clamp-1">
                              {{ base.headquarterAddress }}
                            </p>
                            <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                              <span class="flex items-center gap-1">
                                <i class="pi pi-map-marker text-xs"></i>
                                {{ base.locationDriver.cityName || 'N/A' }}
                              </span>
                              <span class="flex items-center gap-1">
                                <i class="pi pi-box text-xs"></i>
                                {{ base.headquarterAcronym }}
                              </span>
                            </div>
                          </div>
                        </div>
                      </p-card>
                    }
                  }
                </div>
              </div>

              <!-- Mapa -->
              <div class="lg:col-span-2 order-1 lg:order-2">
                <div style="height: 500px;">
                  @if (mapMarkers().length > 0) {
                    <app-google-map
                      [markers]="mapMarkers()"
                      [centerOn]="centerMapOn()"
                      (markerClick)="onMarkerClick($event)"
                    />
                  } @else {
                    <div class="h-full flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded">
                      <div class="text-center">
                        <i class="pi pi-map text-5xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400">
                          No hay bases para mostrar en el mapa
                        </p>
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </p-tabpanel>

        <!-- TAB PANEL 2: TABLA -->
        <p-tabpanel value="1">
          <div class="p-4">
            <!-- Barra de Búsqueda -->
            <div class="mb-4">
              <p-iconfield iconPosition="left" class="w-full md:w-96">
                <p-inputicon class="pi pi-search" />
                <input
                  pInputText
                  type="text"
                  placeholder="Buscar por nombre o dirección..."
                  class="w-full"
                  [ngModel]="searchTerm()"
                  (ngModelChange)="onSearchChange($event)"
                />
              </p-iconfield>
            </div>

            <!-- Tabla Desktop -->
            <div class="hidden md:block">
              <p-table
                [value]="operationBases()"
                [loading]="loading()"
                [lazy]="true"
                [paginator]="true"
                [rows]="pageSize()"
                [totalRecords]="totalCount()"
                [rowsPerPageOptions]="[10, 20, 50]"
                (onLazyLoad)="onPageChange($event)"
                [showCurrentPageReport]="true"
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} bases"
                styleClass="p-datatable-sm"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th style="width: 80px;">Logo</th>
                    <th>Nombre</th>
                    <th>Dirección</th>
                    <th style="width: 120px;">Acrónimo</th>
                    <th style="width: 140px;">Pedidos/Hora</th>
                    <th style="width: 140px;">Drivers/Hora</th>
                    <th style="width: 140px;">País</th>
                    <th style="width: 140px;">Ciudad</th>
                    <th style="width: 100px;">Acciones</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-base>
                  <tr>
                    <td>
                      <img
                        [src]="base.pathLogoHeadquarter"
                        [alt]="base.headquarterName"
                        class="w-10 h-10 rounded object-cover"
                      />
                    </td>
                    <td>{{ base.headquarterName }}</td>
                    <td>
                      <span class="line-clamp-2">{{ base.headquarterAddress }}</span>
                    </td>
                    <td>
                      <span class="font-mono font-semibold">{{ base.headquarterAcronym }}</span>
                    </td>
                    <td class="text-center">{{ base.pedidoPorHora }}</td>
                    <td class="text-center">{{ base.VolDriverPorHora }}</td>
                    <td>{{ base.locationDriver.countryName || 'N/A' }}</td>
                    <td>{{ base.locationDriver.cityName || 'N/A' }}</td>
                    <td>
                      <p-button
                        icon="pi pi-eye"
                        [text]="true"
                        [rounded]="true"
                        severity="secondary"
                        size="small"
                        (onClick)="viewDetails(base.codHeadquarter)"
                      />
                    </td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="9" class="text-center py-8">
                      <i class="pi pi-inbox text-4xl text-gray-400 mb-3"></i>
                      <p class="text-gray-500 dark:text-gray-400 m-0">
                        No se encontraron bases de operaciones
                      </p>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>

            <!-- Cards Mobile -->
            <div class="block md:hidden space-y-3">
              @if (loading()) {
                @for (i of [1,2,3]; track i) {
                  <p-skeleton height="200px" />
                }
              } @else {
                @if (operationBases().length === 0) {
                  <p-card>
                    <div class="text-center py-8">
                      <i class="pi pi-inbox text-4xl text-gray-400 mb-3"></i>
                      <p class="text-gray-500 dark:text-gray-400 m-0">
                        No se encontraron bases de operaciones
                      </p>
                    </div>
                  </p-card>
                } @else {
                  @for (base of operationBases(); track trackByHeadquarterId($index, base)) {
                    <p-card>
                      <div class="space-y-3">
                        <!-- Header -->
                        <div class="flex items-start gap-3 pb-3 border-b border-gray-200 dark:border-gray-700">
                          <img
                            [src]="base.pathLogoHeadquarter"
                            [alt]="base.headquarterName"
                            class="w-16 h-16 rounded object-cover flex-shrink-0"
                          />
                          <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-base m-0 mb-1">
                              {{ base.headquarterName }}
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 m-0">
                              {{ base.headquarterAcronym }}
                            </p>
                          </div>
                        </div>

                        <!-- Details Grid -->
                        <div class="grid grid-cols-2 gap-3 text-sm">
                          <div>
                            <span class="text-gray-500 dark:text-gray-400">Dirección:</span>
                            <p class="font-medium m-0 line-clamp-2">{{ base.headquarterAddress }}</p>
                          </div>
                          <div>
                            <span class="text-gray-500 dark:text-gray-400">Ubicación:</span>
                            <p class="font-medium m-0">
                              {{ base.locationDriver.cityName || 'N/A' }},
                              {{ base.locationDriver.countryName || 'N/A' }}
                            </p>
                          </div>
                          <div>
                            <span class="text-gray-500 dark:text-gray-400">Pedidos/Hora:</span>
                            <p class="font-medium m-0">{{ base.pedidoPorHora }}</p>
                          </div>
                          <div>
                            <span class="text-gray-500 dark:text-gray-400">Drivers/Hora:</span>
                            <p class="font-medium m-0">{{ base.VolDriverPorHora }}</p>
                          </div>
                        </div>

                        <!-- Actions -->
                        <div class="pt-3 border-t border-gray-200 dark:border-gray-700">
                          <p-button
                            label="Ver Detalles"
                            icon="pi pi-eye"
                            [outlined]="true"
                            size="small"
                            styleClass="w-full"
                            (onClick)="viewDetails(base.codHeadquarter)"
                          />
                        </div>
                      </div>
                    </p-card>
                  }
                }
              }
            </div>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>

  <!-- Sidebar de Filtros -->
  <app-operation-bases-filter-sidebar
    [visible]="filterSidebarVisible()"
    (visibleChange)="filterSidebarVisible.set($event)"
    (filtersChange)="onFiltersApply($event)"
  />

  <!-- Toast para notificaciones -->
  <p-toast />
</div>
